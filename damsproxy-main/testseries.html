<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Series Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Fira Code", monospace;
        background-color: #000;
      }
      .terminal-output::after {
        content: "_";
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        50% {
          opacity: 0;
        }
      }
      .explanation {
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body class="text-green-400">
    <div id="terminal" class="p-4 md:p-8 min-h-screen flex flex-col">
      <nav
        class="border-b border-green-900/50 pb-4 mb-4 flex justify-between items-center"
      >
        <div
          id="breadcrumbs"
          class="flex items-center space-x-2 text-sm text-gray-400"
        ></div>
        <a
          href="index.html"
          class="bg-red-800/50 hover:bg-red-700/50 text-red-300 font-bold py-2 px-4 rounded-md whitespace-nowrap"
          >[Exit Terminal]</a
        >
      </nav>

      <header class="mb-4">
        <p id="course-title-header" class="text-2xl text-yellow-400"></p>
        <div id="terminal-nav" class="mt-2 flex items-center gap-4"></div>
      </header>

      <main id="terminal-content" class="space-y-2 flex-1"></main>

      <div class="mt-4">
        <span class="text-cyan-400">user@dams:~$</span>
        <span class="terminal-output"></span>
      </div>
    </div>

    <script>
      const WORKER_URL = "https://compute.anyme.workers.dev";
      const terminalContent = document.getElementById("terminal-content");
      const courseTitleHeader = document.getElementById("course-title-header");
      const terminalNav = document.getElementById("terminal-nav");
      const breadcrumbsEl = document.getElementById("breadcrumbs");

      let state = {};

      // --- UI Rendering Functions ---
      function getFileExtension(url) {
        if (!url) return "";
        try {
          const path = new URL(url).pathname;
          const extension = path.split(".").pop();
          return extension && extension.length <= 4 ? `.${extension}` : ".file";
        } catch (e) {
          return ".file";
        }
      }

      function updateBreadcrumbs() {
        breadcrumbsEl.innerHTML = "";
        let path = `<span class="text-gray-500">./TestSeries</span>`;
        if (state.courseTitle)
          path += `<span class="text-gray-600">/</span><span class="text-green-500">${state.courseTitle}</span>`;
        if (state.currentTopicName)
          path += `<span class="text-gray-600">/</span><span class="text-green-500">${state.currentTopicName}</span>`;
        if (state.currentTestName)
          path += `<span class="text-gray-600">/</span><span class="text-green-500">${state.currentTestName}</span>`;
        breadcrumbsEl.innerHTML = path;
      }

      function renderTopics() {
        state.currentTopicName = null;
        state.currentTestName = null;
        updateBreadcrumbs();
        terminalNav.innerHTML = "";
        let output =
          '<p>Select a topic to continue:</p><ul class="list-disc list-inside">';
        state.topics.forEach((topicName) => {
          output += `<li class="hover:bg-green-900/50 cursor-pointer" onclick="renderTestsForTopic('${topicName}')">
                            ${topicName}
                           </li>`;
        });
        output += "</ul>";
        terminalContent.innerHTML = output;
      }

      function renderTestsForTopic(topicName) {
        state.currentTopicName = topicName;
        state.currentTestName = null;
        updateBreadcrumbs();
        terminalNav.innerHTML = `<button class="text-sm hover:text-yellow-300" onclick="renderTopics()">&lt;&lt; Back to Topics</button>`;
        const testsForTopic = state.allTests.filter(
          (test) => test.topic_name === topicName
        );
        if (!testsForTopic.length) {
          terminalContent.innerHTML = `<p class="text-yellow-400">[!] No tests found for ${topicName}.</p>`;
          return;
        }
        let output = `<p>Select a test from <span class="text-yellow-400">${topicName}</span>:</p><ul class="list-disc list-inside">`;
        testsForTopic.forEach((test) => {
          output += `<li class="hover:bg-green-900/50 cursor-pointer" onclick="fetchAndStartQuiz('${test.test_series_id}', '${test.test_series_name}')">
                            ${test.test_series_name} (${test.total_questions} Qs / ${test.time_in_mins} mins)
                           </li>`;
        });
        output += "</ul>";
        terminalContent.innerHTML = output;
      }

      function renderQuiz() {
        const question = state.questions[state.currentQuestionIndex];
        const optionsHtml = [
          question.option_1,
          question.option_2,
          question.option_3,
          question.option_4,
          question.option_5,
        ]
          .filter((opt) => opt)
          .map(
            (opt, index) =>
              `<li id="option-${
                index + 1
              }" class="hover:bg-green-900/50 cursor-pointer p-1" onclick="selectAnswer(${
                index + 1
              })">[${index + 1}] ${opt}</li>`
          )
          .join("");
        const navHtml = `<div class="flex justify-between mt-4"><button class="bg-gray-700 hover:bg-gray-600 px-4 py-1 rounded disabled:opacity-50" onclick="navigateQuiz(-1)" ${
          state.currentQuestionIndex === 0 ? "disabled" : ""
        }>&lt; Prev</button><span>${state.currentQuestionIndex + 1} / ${
          state.questions.length
        }</span><button class="bg-gray-700 hover:bg-gray-600 px-4 py-1 rounded disabled:opacity-50" onclick="navigateQuiz(1)" ${
          state.currentQuestionIndex === state.questions.length - 1
            ? "disabled"
            : ""
        }>Next &gt;</button></div>`;
        const scoreHtml = `<p class="mt-4 text-yellow-400">Score: ${state.score} / ${state.questions.length}</p>`;
        terminalContent.innerHTML = `<p class="text-cyan-400">${question.question}</p><ul class="mt-2 space-y-1">${optionsHtml}</ul><div id="explanation-container" class="mt-4 hidden"></div>${navHtml}${scoreHtml}`;
      }

      function selectAnswer(selectedIndex) {
        const question = state.questions[state.currentQuestionIndex];
        const correctAnswerIndex = parseInt(question.answer);
        if (document.getElementById(`option-${selectedIndex}`).dataset.answered)
          return;
        if (selectedIndex === correctAnswerIndex) {
          state.score++;
        }
        for (let i = 1; i <= 5; i++) {
          const optionEl = document.getElementById(`option-${i}`);
          if (!optionEl) continue;
          optionEl.dataset.answered = "true";
          optionEl.classList.remove("hover:bg-green-900/50", "cursor-pointer");
          if (i === correctAnswerIndex)
            optionEl.classList.add("text-black", "bg-green-500");
          if (i === selectedIndex && selectedIndex !== correctAnswerIndex)
            optionEl.classList.add("text-black", "bg-red-500");
        }
        const explanationContainer = document.getElementById(
          "explanation-container"
        );
        let explanationHtml = `<p class="font-bold text-yellow-400">Explanation:</p><p class="explanation text-gray-400">${question.description}</p>`;

        // --- THIS IS THE FIX ---
        // Changed `question.video_url_exp` to `question.video_url_explanation` to match the API response.
        if (question.video_url_explanation) {
          const videoExt = getFileExtension(question.video_url_explanation);
          const videoFileName = `${question.question
            .substring(0, 30)
            .trim()} - Explanation${videoExt}`;
          const videoDownloadUrl = `${WORKER_URL}?action=download&filename=${encodeURIComponent(
            videoFileName
          )}&url=${encodeURIComponent(question.video_url_explanation)}`;
          explanationHtml += `<a href="${videoDownloadUrl}" class="inline-block mt-2 bg-blue-800/50 hover:bg-blue-700/50 text-blue-300 font-bold py-1 px-3 rounded-md">[Download Video Explanation]</a>`;
        }

        explanationContainer.innerHTML = explanationHtml;
        explanationContainer.classList.remove("hidden");
        document.querySelector(
          ".text-yellow-400"
        ).textContent = `Score: ${state.score} / ${state.questions.length}`;
      }

      function navigateQuiz(direction) {
        state.currentQuestionIndex += direction;
        renderQuiz();
      }

      // --- DATA FETCHING FUNCTIONS ---
      async function fetchAndStartQuiz(testSeriesId, testName) {
        state.currentTestName = testName;
        updateBreadcrumbs();
        terminalContent.innerHTML = `<p class="animate-pulse">Loading quiz: ${testName}...</p>`;
        try {
          const data = await (
            await fetch(
              `${WORKER_URL}?view=test_series_questions&test_series_id=${testSeriesId}`
            )
          ).json();
          state.questions = data.questions;
          state.basic_info = data.basic_info;

          if (!state.questions || state.questions.length === 0) {
            terminalContent.innerHTML = `<p class="text-yellow-400">[!] No questions found for this test.</p>`;
            terminalNav.innerHTML = `<button class="text-sm hover:text-yellow-300" onclick="renderTestsForTopic(state.currentTopicName)">&lt;&lt; Back to Tests</button>`;
            return;
          }

          state.currentQuestionIndex = 0;
          state.score = 0;
          let navHtml = `<button class="text-sm hover:text-yellow-300" onclick="renderTestsForTopic(state.currentTopicName)">&lt;&lt; Back to Tests</button>`;
          if (state.basic_info.pdf_solution) {
            const pdfExt = getFileExtension(state.basic_info.pdf_solution);
            const pdfFileName = `${state.currentTestName} - Solution${pdfExt}`;
            const pdfDownloadUrl = `${WORKER_URL}?action=download&filename=${encodeURIComponent(
              pdfFileName
            )}&url=${encodeURIComponent(state.basic_info.pdf_solution)}`;
            navHtml += `<a href="${pdfDownloadUrl}" class="bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-bold py-1 px-3 rounded-md">[Download PDF Solution]</a>`;
          }
          terminalNav.innerHTML = navHtml;
          renderQuiz();
        } catch (error) {
          console.error("Test Series Error:", error);
          terminalContent.innerHTML = `<p class="text-red-500">[ERROR] Could not retrieve questions for this test.</p>`;
        }
      }

      async function fetchAndDisplayTestTopics() {
        terminalContent.innerHTML = `<p class="animate-pulse">Fetching test series from secure server...</p>`;
        try {
          const response = await fetch(
            `${WORKER_URL}?view=test_series_list&course_id=${state.courseId}`
          );
          if (!response.ok) throw new Error("Failed to load test series");
          state.allTests = await response.json();
          // Group tests by topic_name
          const topics = [
            ...new Set(state.allTests.map((test) => test.topic_name)),
          ];
          state.topics = topics;
          renderTopics();
        } catch (error) {
          console.error("Test Series Error:", error);
          terminalContent.innerHTML = `<p class="text-red-500">[ERROR] Could not retrieve test series list. Connection to host may be down.</p>`;
        }
      }

      // --- INITIALIZATION ---
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        state.courseId = params.get("course_id");
        state.courseTitle = params.get("title");
        if (!state.courseId || !state.courseTitle) {
          terminalContent.innerHTML = `<p class="text-red-500">[FATAL_ERROR] Course ID not provided. Cannot initialize terminal.</p>`;
          return;
        }
        courseTitleHeader.textContent = `[Test Series: ${state.courseTitle}]`;
        fetchAndDisplayTestTopics();
      });
    </script>
  </body>
</html>
