<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - DAMS Content Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
       :root {
         /* Enhanced Color Palette */
         --primary-600: #0d9488;
         --primary-500: #10b981;
         --primary-400: #34d399;
         --secondary-600: #3b82f6;
         --secondary-500: #6366f1;
         --accent-600: #8b5cf6;
         --accent-500: #a855f7;
         --success-500: #10b981;
         --warning-500: #f59e0b;
         --error-500: #ef4444;
         --gray-900: #111827;
         --gray-800: #1f2937;
         --gray-700: #374151;
         --gray-600: #4b5563;
         --gray-500: #6b7280;
         --gray-400: #9ca3af;
         --gray-300: #d1d5db;
       }

       body {
         font-family: "Fira Code", monospace;
         background: linear-gradient(135deg, #000 0%, #0a0a0a 100%);
         min-height: 100vh;
         overflow-x: hidden;
         line-height: 1.6;
       }

       /* Enhanced Typography */
       .heading-1 { font-size: 2.5rem; font-weight: 700; line-height: 1.2; }
       .heading-2 { font-size: 2rem; font-weight: 600; line-height: 1.3; }
       .heading-3 { font-size: 1.5rem; font-weight: 600; line-height: 1.4; }
       .body-large { font-size: 1.125rem; line-height: 1.6; }
       .body { font-size: 1rem; line-height: 1.6; }
       .caption { font-size: 0.875rem; line-height: 1.4; }

       /* Enhanced Card Design with Glass Morphism */
       .content-card {
         background: rgba(255, 255, 255, 0.03);
         backdrop-filter: blur(10px);
         border: 1px solid rgba(255, 255, 255, 0.08);
         border-radius: 12px;
         transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
         position: relative;
         overflow: hidden;
         box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
       }

       .content-card:hover {
         transform: translateY(-2px);
         border-color: rgba(13, 148, 136, 0.3);
         box-shadow: 0 8px 32px rgba(13, 148, 136, 0.15);
         background: rgba(255, 255, 255, 0.05);
       }

       /* Skeleton Loading */
       .skeleton {
         background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
         background-size: 200px 100%;
         animation: shimmer 2s infinite;
         border-radius: 8px;
       }

       @keyframes shimmer {
         0% { background-position: -200px 0; }
         100% { background-position: 200px 0; }
       }

       /* Enhanced Button Styles */
       .btn-enhanced {
         background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-500) 100%);
         background-size: 200% 200%;
         border: none;
         border-radius: 12px;
         padding: 12px 24px;
         color: white;
         font-weight: 600;
         transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
         position: relative;
         overflow: hidden;
         cursor: pointer;
         box-shadow: 0 4px 16px rgba(13, 148, 136, 0.3);
       }

       .btn-enhanced::before {
         content: '';
         position: absolute;
         top: 0;
         left: -100%;
         width: 100%;
         height: 100%;
         background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
         transition: left 0.6s ease;
       }

       .btn-enhanced:hover::before {
         left: 100%;
       }

       .btn-enhanced:hover {
         transform: translateY(-2px) scale(1.02);
         box-shadow: 0 8px 24px rgba(13, 148, 136, 0.4);
         background-position: right center;
       }

       /* Status Badges */
       .status-badge {
         display: inline-flex;
         align-items: center;
         padding: 4px 12px;
         border-radius: 20px;
         font-size: 0.75rem;
         font-weight: 600;
         text-transform: uppercase;
         letter-spacing: 0.05em;
       }

       .status-online { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
       .status-offline { background: rgba(107, 114, 128, 0.2); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.3); }
       .status-admin { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
       .status-supreme { background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
       .status-user { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }

       /* Enhanced Scrollbar */
       ::-webkit-scrollbar {
         width: 8px;
       }

       ::-webkit-scrollbar-track {
         background: rgba(255, 255, 255, 0.05);
       }

       ::-webkit-scrollbar-thumb {
         background: var(--primary-600);
         border-radius: 4px;
         transition: background 0.3s ease;
       }

       ::-webkit-scrollbar-thumb:hover {
         background: var(--primary-500);
       }

       /* Loading Spinner */
       .spinner {
         width: 20px;
         height: 20px;
         border: 2px solid rgba(255, 255, 255, 0.1);
         border-left: 2px solid var(--primary-500);
         border-radius: 50%;
         animation: spin 1s linear infinite;
       }

       @keyframes spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
       }

       /* Enhanced Focus States */
       .focus-enhanced:focus {
         outline: none;
         box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3);
         border-color: var(--primary-500);
       }

       /* Mobile Optimizations */
       @media (max-width: 768px) {
         .heading-1 { font-size: 2rem; }
         .heading-2 { font-size: 1.75rem; }
         .heading-3 { font-size: 1.25rem; }
         .content-card { margin: 0 8px; }
       }

      .btn-primary {
        background: linear-gradient(
          135deg,
          #0d9488 0%,
          #14b8a6 50%,
          #0d9488 100%
        );
        background-size: 200% 200%;
        border: none;
        border-radius: 12px;
        padding: 14px 28px;
        color: white;
        font-weight: 600;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(13, 148, 136, 0.3);
        cursor: pointer;
        pointer-events: auto;
        z-index: 10;
      }

      .btn-primary::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s ease;
        pointer-events: none;
        z-index: 1;
      }

      .btn-primary:hover::before {
        left: 100%;
      }

      .btn-primary:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 15px 35px rgba(13, 148, 136, 0.4);
        background-position: right center;
      }

      .btn-primary:active {
        transform: translateY(-1px) scale(1.02);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 20px;
        color: #d1d5db;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-secondary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
      }

      .btn-secondary:hover::before {
        left: 100%;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        color: #f3f4f6;
        transform: translateY(-1px);
      }

      .btn-secondary:active {
        transform: translateY(0px);
      }
    </style>
  </head>
  <body class="bg-black text-green-400">
    <div class="min-h-screen">
      <!-- Enhanced Header -->
      <header class="bg-gray-900/80 backdrop-blur-md border-b border-gray-700/50 p-4 sticky top-0 z-50">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center space-x-4">
            <a href="index.html" class="text-primary-400 hover:text-primary-300 transition-colors duration-200 focus-enhanced p-2 rounded-lg">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
            </a>
            <div>
              <h1 class="heading-2 text-primary-400 font-bold">Admin Dashboard</h1>
              <p class="caption text-gray-400">v2.4.0 â€¢ System Management</p>
            </div>
          </div>
          <div class="flex items-center space-x-3">
            <div class="hidden sm:block text-right">
              <p class="body text-gray-300">Welcome back, Admin</p>
              <p class="caption text-gray-400" id="current-time">Loading...</p>
            </div>
            <button
              id="logout-admin-btn"
              class="btn-enhanced bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all duration-200 focus-enhanced"
            >
              <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
              Logout
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <!-- MOBILE FIX: Responsive padding for main content area -->
      <main class="container mx-auto p-4 md:p-6">
        <!-- Enhanced Stats Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
          <!-- Primary Metrics Row -->
          <div class="lg:col-span-3">
            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-4">
              <div class="content-card p-6 relative overflow-hidden group">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="caption text-gray-400 mb-2 font-medium">Total Users</h3>
                    <p class="heading-3 text-white font-bold" id="total-users">0</p>
                    <div class="mt-3 flex items-center text-xs">
                      <svg class="w-3 h-3 text-green-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                      </svg>
                      <span id="user-growth" class="text-green-400">+0%</span>
                      <span class="text-gray-400 ml-1">from last month</span>
                    </div>
                  </div>
                  <div class="w-14 h-14 bg-gradient-to-br from-green-500/20 to-green-600/20 rounded-xl flex items-center justify-center ml-4 group-hover:scale-110 transition-transform duration-200">
                    <svg class="w-7 h-7 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                  </div>
                </div>
              </div>

              <div class="content-card p-6 relative overflow-hidden group">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="caption text-gray-400 mb-2 font-medium">Active Now</h3>
                    <p class="heading-3 text-white font-bold" id="online-users">0</p>
                    <div class="mt-3 flex items-center text-xs">
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse mr-2"></div>
                      <span id="active-rate" class="text-blue-400">0%</span>
                      <span class="text-gray-400 ml-1">of total users</span>
                    </div>
                  </div>
                  <div class="w-14 h-14 bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-xl flex items-center justify-center ml-4 group-hover:scale-110 transition-transform duration-200">
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                  </div>
                </div>
              </div>

              <div class="content-card p-6 relative overflow-hidden group">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="caption text-gray-400 mb-2 font-medium">Pending Codes</h3>
                    <p class="heading-3 text-white font-bold" id="pending-codes">0</p>
                    <div class="mt-3 flex items-center text-xs">
                      <svg class="w-3 h-3 text-yellow-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                      <span id="code-usage" class="text-yellow-400">0%</span>
                      <span class="text-gray-400 ml-1">utilization rate</span>
                    </div>
                  </div>
                  <div class="w-14 h-14 bg-gradient-to-br from-yellow-500/20 to-yellow-600/20 rounded-xl flex items-center justify-center ml-4 group-hover:scale-110 transition-transform duration-200">
                    <svg class="w-7 h-7 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                  </div>
                </div>
              </div>

              <div class="content-card p-6 relative overflow-hidden group">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="caption text-gray-400 mb-2 font-medium">System Load</h3>
                    <p class="heading-3 text-white font-bold" id="system-load">0%</p>
                    <div class="mt-3 flex items-center text-xs">
                      <div class="w-3 h-3 bg-purple-400 rounded-full mr-2"></div>
                      <span id="load-status" class="text-purple-400">Optimal</span>
                    </div>
                  </div>
                  <div class="w-14 h-14 bg-gradient-to-br from-purple-500/20 to-purple-600/20 rounded-xl flex items-center justify-center ml-4 group-hover:scale-110 transition-transform duration-200">
                    <svg class="w-7 h-7 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                </div>
              </div>

              <div class="content-card p-6 relative overflow-hidden group">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="caption text-gray-400 mb-2 font-medium">API Health</h3>
                    <p class="heading-3 text-white font-bold" id="api-health">100%</p>
                    <div class="mt-3 flex items-center text-xs">
                      <svg class="w-3 h-3 text-green-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <span id="api-response" class="text-green-400">0ms</span>
                      <span class="text-gray-400 ml-1">avg response</span>
                    </div>
                  </div>
                  <div class="w-14 h-14 bg-gradient-to-br from-green-500/20 to-green-600/20 rounded-xl flex items-center justify-center ml-4 group-hover:scale-110 transition-transform duration-200">
                    <svg class="w-7 h-7 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- System Status Card -->
          <div class="content-card p-6">
            <h3 class="text-lg font-bold text-green-400 mb-4">System Status</h3>
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-400">Worker Status</span>
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-600/20 text-green-300 border border-green-600/30">Online</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-400">KV Storage</span>
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-600/20 text-green-300 border border-green-600/30">Connected</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-400">API Gateway</span>
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-600/20 text-green-300 border border-green-600/30">Active</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-400">Build Version</span>
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-600/20 text-blue-300 border border-blue-600/30" id="current-build">521</span>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700/50">
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400">Last Update</span>
                <span class="text-green-300" id="last-update">Just now</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Analytics Section -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
          <!-- Main Metrics -->
          <div class="xl:col-span-2 space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="content-card p-6">
                <h3 class="text-lg font-bold text-green-400 mb-4">User Growth Analytics</h3>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">New Users (7 days)</span>
                    <span class="text-lg font-bold text-green-300" id="weekly-users">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">New Users (30 days)</span>
                    <span class="text-lg font-bold text-green-300" id="monthly-users">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Growth Rate</span>
                    <span class="text-lg font-bold text-green-300" id="growth-rate">0%</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Avg Daily Signups</span>
                    <span class="text-lg font-bold text-green-300" id="avg-daily">0</span>
                  </div>
                </div>
              </div>
              <div class="content-card p-6">
                <h3 class="text-lg font-bold text-yellow-400 mb-4">Code Utilization Analytics</h3>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Active Codes</span>
                    <span class="text-lg font-bold text-green-300" id="active-codes">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Used Codes</span>
                    <span class="text-lg font-bold text-blue-300" id="used-codes">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Expired Codes</span>
                    <span class="text-lg font-bold text-red-300" id="expired-codes">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Utilization Rate</span>
                    <span class="text-lg font-bold text-yellow-300" id="utilization-rate">0%</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Activity Summary -->
            <div class="content-card p-6">
              <h3 class="text-lg font-bold text-blue-400 mb-4">Activity Summary</h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-400" id="today-logins">0</div>
                  <div class="text-xs text-gray-400">Today Logins</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400" id="week-logins">0</div>
                  <div class="text-xs text-gray-400">Week Logins</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-purple-400" id="month-logins">0</div>
                  <div class="text-xs text-gray-400">Month Logins</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-yellow-400" id="peak-hour">0</div>
                  <div class="text-xs text-gray-400">Peak Hour</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Analytics Sidebar -->
          <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="content-card p-6">
              <h3 class="text-lg font-bold text-green-400 mb-4">Quick Actions</h3>
              <div class="space-y-3">
                <button id="bulk-generate-codes" class="w-full bg-green-800/50 hover:bg-green-700/50 text-green-300 font-medium py-3 px-4 rounded-lg border border-green-700/50 transition-all duration-300">
                  Generate 10 Codes
                </button>
                <button id="export-user-report" class="w-full bg-blue-800/50 hover:bg-blue-700/50 text-blue-300 font-medium py-3 px-4 rounded-lg border border-blue-700/50 transition-all duration-300">
                  Export User Report
                </button>
                <button id="system-health-check" class="w-full bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-medium py-3 px-4 rounded-lg border border-purple-700/50 transition-all duration-300">
                  Health Check
                </button>
                <button id="clear-activity-logs" class="w-full bg-red-800/50 hover:bg-red-700/50 text-red-300 font-medium py-3 px-4 rounded-lg border border-red-700/50 transition-all duration-300">
                  Clear Logs
                </button>
                <button id="remove-expired-codes" class="w-full bg-red-800/50 hover:bg-red-700/50 text-red-300 font-medium py-3 px-4 rounded-lg border border-red-700/50 transition-all duration-300">
                  Remove Expired Codes
                </button>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="content-card p-6">
              <h3 class="text-lg font-bold text-yellow-400 mb-4">Recent Activity</h3>
              <div id="recent-activity" class="space-y-3 max-h-64 overflow-y-auto">
                <div class="text-sm text-gray-400 italic">No recent activity</div>
              </div>
            </div>

            <!-- System Alerts -->
            <div class="content-card p-6">
              <h3 class="text-lg font-bold text-red-400 mb-4">System Alerts</h3>
              <div id="system-alerts" class="space-y-2">
                <div class="text-sm text-green-400 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  All systems operational
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced User Management Section -->
        <div class="content-card p-6 mb-8">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
            <div>
              <h2 class="heading-2 text-white font-bold">User Management</h2>
              <p class="caption text-gray-400 mt-1">Manage user accounts and permissions</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button id="generate-code-btn" class="btn-primary flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <span>Generate Codes</span>
              </button>
              <button id="export-users-btn" class="btn-secondary flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>Export Data</span>
              </button>
              <button id="import-users-btn" class="btn-secondary flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <span>Import Users</span>
              </button>
            </div>
          </div>

          <!-- Advanced Filters -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-900/30 rounded-lg border border-gray-700/50">
            <div>
              <label class="block text-sm font-semibold text-gray-300 mb-2">Search Users</label>
              <div class="relative">
                <input
                  type="text"
                  id="user-search"
                  placeholder="Name, email, or role..."
                  class="w-full bg-gray-800/50 border border-gray-600/50 rounded-lg p-3 pl-10 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all duration-200"
                />
                <svg class="absolute left-3 top-3.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-300 mb-2">Filter by Status</label>
              <select id="user-status-filter" class="w-full bg-gray-800/50 border border-gray-600/50 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all duration-200">
                <option value="all">All Status</option>
                <option value="online">Online Now</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="expired">Expired</option>
                <option value="admin">Administrators</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-300 mb-2">Filter by Role</label>
              <select id="user-role-filter" class="w-full bg-gray-800/50 border border-gray-600/50 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all duration-200">
                <option value="all">All Roles</option>
                <option value="user">Users</option>
                <option value="admin">Admins</option>
                <option value="supreme">Supreme</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-300 mb-2">Sort Results</label>
              <select id="user-sort-filter" class="w-full bg-gray-800/50 border border-gray-600/50 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all duration-200">
                <option value="created_at_desc">Newest First</option>
                <option value="created_at_asc">Oldest First</option>
                <option value="name_asc">Name A-Z</option>
                <option value="name_desc">Name Z-A</option>
                <option value="last_seen_desc">Recently Active</option>
              </select>
            </div>
          </div>

          <!-- Bulk Actions Bar -->
          <div id="bulk-action-bar" class="hidden bg-gradient-to-r from-gray-800/50 to-gray-700/50 p-4 rounded-lg mb-4 border border-gray-600/50 backdrop-blur-sm">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
              <div class="flex items-center space-x-4">
                <input type="checkbox" id="select-all-users" class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2">
                <span id="selection-count" class="text-sm text-blue-300 font-semibold">0 users selected</span>
              </div>
              <div class="flex flex-wrap gap-2">
                <button id="bulk-email-btn" class="btn-secondary flex items-center space-x-2 text-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                  <span>Email Selected</span>
                </button>
                <button id="bulk-reset-password-btn" class="btn-secondary flex items-center space-x-2 text-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                  </svg>
                  <span>Reset Passwords</span>
                </button>
                <button id="bulk-extend-btn" class="btn-secondary flex items-center space-x-2 text-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>Extend Access</span>
                </button>
                <div class="flex space-x-1">
                  <button id="bulk-extend-30-btn" class="bg-green-600/20 hover:bg-green-600/30 text-green-300 font-semibold py-2 px-3 rounded-lg text-sm border border-green-600/30 transition-all duration-200">
                    +30 Days
                  </button>
                  <button id="bulk-extend-60-btn" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-300 font-semibold py-2 px-3 rounded-lg text-sm border border-blue-600/30 transition-all duration-200">
                    +60 Days
                  </button>
                </div>
                <button id="bulk-delete-btn" class="bg-red-600/20 hover:bg-red-600/30 text-red-300 font-semibold py-2 px-3 rounded-lg text-sm border border-red-600/30 transition-all duration-200 flex items-center space-x-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  <span>Delete Selected</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Users Table -->
          <div class="overflow-x-auto rounded-lg border border-gray-700/50 bg-gray-900/20">
            <table class="w-full text-sm">
              <thead class="bg-gradient-to-r from-gray-800/50 to-gray-700/50">
                <tr>
                  <!-- BULK ACTIONS FIX: Added checkbox header -->
                  <th class="px-6 py-4 text-left">
                    <input
                      type="checkbox"
                      id="select-all-users"
                      class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                    />
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">
                    User Details
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">
                    Status
                  </th>
                  <!-- EXPIRY DATE FIX: Added new table header -->
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">
                    Expires
                  </th>
                  <th class="hidden md:table-cell px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">
                    Joined
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="users-table-body" class="divide-y divide-gray-700/30">
                <!-- User rows will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Activation Codes Section -->
        <div class="content-card p-4 sm:p-6 mb-8">
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"
          >
            <h2 class="text-2xl font-bold text-green-400">Activation Codes</h2>
            <!-- UNUSED CODES FIX: Added new button -->
            <div
              class="flex flex-col sm:flex-row w-full sm:w-auto space-y-2 sm:space-y-0 sm:space-x-4"
            >
              <button
                onclick="copyUnusedCodes()"
                class="bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-bold py-2 px-4 rounded-md text-sm w-full"
              >
                [Copy Unused]
              </button>
              <button
                onclick="copyAllCodes()"
                class="btn-primary px-4 py-2 text-sm font-medium w-full"
              >
                [COPY ALL]
              </button>
              <button
                onclick="removeExpiredCodes()"
                class="bg-red-800/50 hover:bg-red-700/50 text-red-300 font-bold py-2 px-4 rounded-md text-sm w-full border border-red-700/50"
              >
                [Remove Expired]
              </button>
            </div>
          </div>

          <!-- SEARCH BAR FIX: Added search bar for codes -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <input
              type="text"
              id="code-search"
              placeholder="Search codes..."
              class="flex-1 bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
            />
            <select
              id="code-status-filter"
              class="bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
            >
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="used">Used</option>
              <option value="expired">Expired</option>
            </select>
          </div>

          <!-- Codes Table -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-800/50">
                <tr>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                  >
                    Code
                  </th>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                  >
                    Status
                  </th>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                  >
                    Expires
                  </th>
                  <!-- MOBILE FIX: Hide less important columns on smaller screens -->
                  <th
                    class="hidden md:table-cell px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                  >
                    Used By
                  </th>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="codes-table-body" class="divide-y divide-gray-700/50">
                <!-- Code rows will be populated here -->
              </tbody>
            </table>
          </div>

          <!-- Enhanced Pagination -->
          <div id="user-pagination" class="flex items-center justify-between mt-6 px-2">
            <div class="text-sm text-gray-400">
              Showing <span id="user-start" class="text-blue-400 font-semibold">0</span> to <span id="user-end" class="text-blue-400 font-semibold">0</span> of <span id="user-total" class="text-blue-400 font-semibold">0</span> users
            </div>
            <div class="flex items-center space-x-2">
              <button id="prev-page" class="btn-secondary px-3 py-2 text-sm" disabled>
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Previous
              </button>
              <div class="flex items-center space-x-1">
                <span id="current-page" class="px-3 py-2 text-sm text-gray-300 bg-gray-800/50 rounded-lg">1</span>
              </div>
              <button id="next-page" class="btn-secondary px-3 py-2 text-sm">
                Next
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Announcements Management -->
        <div class="content-card p-6 mb-8">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-bold text-green-400">Announcements</h2>
              <p class="text-sm text-gray-400 mt-1">Create and manage system announcements</p>
            </div>
            <button id="create-announcement-btn" class="btn-primary px-4 py-2 text-sm font-medium">
              Create Announcement
            </button>
          </div>

          <!-- Active Announcements -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="content-card p-4">
              <h3 class="text-lg font-bold text-blue-400 mb-4">Active Announcements</h3>
              <div id="announcements-list" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="text-sm text-gray-400 italic">Loading announcements...</div>
              </div>
            </div>

            <div class="content-card p-4">
              <h3 class="text-lg font-bold text-green-400 mb-4">Create New Announcement</h3>
              <form id="announcement-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-bold text-gray-400 mb-2">Title</label>
                  <input type="text" id="announcement-title" required
                    class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
                    placeholder="Announcement title">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-400 mb-2">Content</label>
                  <textarea id="announcement-content" required rows="4"
                    class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
                    placeholder="Announcement content"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-bold text-gray-400 mb-2">Type</label>
                    <select id="announcement-type"
                      class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500">
                      <option value="info">Info</option>
                      <option value="success">Success</option>
                      <option value="warning">Warning</option>
                      <option value="error">Error</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-bold text-gray-400 mb-2">Priority</label>
                    <select id="announcement-priority"
                      class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500">
                      <option value="low">Low</option>
                      <option value="normal">Normal</option>
                      <option value="high">High</option>
                      <option value="urgent">Urgent</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-400 mb-2">Expires At (Optional)</label>
                  <input type="datetime-local" id="announcement-expires"
                    class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500">
                </div>
                <button type="submit" class="w-full btn-primary py-3 font-bold">
                  Create Announcement
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Enhanced System Management -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <!-- Advanced Analytics Dashboard -->
          <div class="content-card p-6">
            <h2 class="text-2xl font-bold text-green-400 mb-6">Advanced Analytics</h2>

            <!-- User Growth Chart -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-gray-400 mb-3">User Growth Trend</h4>
              <div class="relative h-32 bg-gray-900/30 rounded-lg p-4">
                <canvas id="userGrowthChart" class="w-full h-full"></canvas>
              </div>
            </div>

            <!-- Code Utilization Chart -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-gray-400 mb-3">Code Utilization</h4>
              <div class="relative h-32 bg-gray-900/30 rounded-lg p-4">
                <canvas id="codeUtilizationChart" class="w-full h-full"></canvas>
              </div>
            </div>

            <!-- Activity Heatmap -->
            <div>
              <h4 class="text-sm font-medium text-gray-400 mb-3">Activity Heatmap</h4>
              <div class="grid grid-cols-7 gap-1">
                <div class="h-8 bg-green-600/20 rounded" title="Mon: High"></div>
                <div class="h-8 bg-blue-600/30 rounded" title="Tue: Medium"></div>
                <div class="h-8 bg-green-600/40 rounded" title="Wed: High"></div>
                <div class="h-8 bg-yellow-600/30 rounded" title="Thu: Medium"></div>
                <div class="h-8 bg-green-600/60 rounded" title="Fri: Very High"></div>
                <div class="h-8 bg-blue-600/20 rounded" title="Sat: Low"></div>
                <div class="h-8 bg-gray-600/20 rounded" title="Sun: Low"></div>
              </div>
              <div class="flex justify-between text-xs text-gray-400 mt-2">
                <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
              </div>
            </div>
          </div>

          <!-- Real-time System Monitoring -->
          <div class="content-card p-6">
            <h2 class="text-2xl font-bold text-green-400 mb-6">Real-time Monitoring</h2>

            <!-- Performance Metrics -->
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div class="bg-gray-900/30 p-4 rounded-lg">
                <h4 class="text-sm font-medium text-gray-400 mb-2">CPU Usage</h4>
                <div class="flex items-center space-x-2">
                  <div class="flex-1 bg-gray-700 rounded-full h-2">
                    <div id="cpu-usage-bar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 15%"></div>
                  </div>
                  <span id="cpu-usage-text" class="text-sm text-green-400">15%</span>
                </div>
              </div>
              <div class="bg-gray-900/30 p-4 rounded-lg">
                <h4 class="text-sm font-medium text-gray-400 mb-2">Memory Usage</h4>
                <div class="flex items-center space-x-2">
                  <div class="flex-1 bg-gray-700 rounded-full h-2">
                    <div id="memory-usage-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 45%"></div>
                  </div>
                  <span id="memory-usage-text" class="text-sm text-blue-400">45%</span>
                </div>
              </div>
            </div>

            <!-- Network Metrics -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-gray-400 mb-3">Network Metrics</h4>
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-300">Active Connections</span>
                  <span id="active-connections" class="text-sm text-green-400">24</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-300">Requests/min</span>
                  <span id="requests-per-min" class="text-sm text-blue-400">156</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-300">Error Rate</span>
                  <span id="error-rate" class="text-sm text-red-400">0.02%</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-300">Bandwidth</span>
                  <span id="bandwidth-usage" class="text-sm text-yellow-400">2.4 MB/s</span>
                </div>
              </div>
            </div>

            <!-- API Response Times -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-gray-400 mb-3">API Response Times</h4>
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-300">Categories API</span>
                  <span id="api-categories-time" class="text-sm text-green-400">0ms</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-300">Courses API</span>
                  <span id="api-courses-time" class="text-sm text-green-400">0ms</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-300">Videos API</span>
                  <span id="api-videos-time" class="text-sm text-green-400">0ms</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-300">Auth API</span>
                  <span id="api-auth-time" class="text-sm text-green-400">0ms</span>
                </div>
              </div>
            </div>

            <!-- System Logs -->
            <div>
              <h4 class="text-sm font-medium text-gray-400 mb-3">Live System Logs</h4>
              <div id="system-logs" class="bg-gray-900/50 rounded-lg p-3 max-h-32 overflow-y-auto text-xs font-mono space-y-1">
                <div class="text-green-400">[INFO] System started successfully</div>
                <div class="text-blue-400">[INFO] KV storage connected</div>
                <div class="text-green-400">[INFO] API endpoints initialized</div>
              </div>
            </div>
          </div>

          <!-- Security & Audit Dashboard -->
          <div class="content-card p-6">
            <h2 class="text-2xl font-bold text-green-400 mb-6">Security & Audit</h2>

            <!-- Security Status -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-gray-400 mb-3">Security Status</h4>
              <div class="space-y-2">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-300">Failed Logins</span>
                  <span id="failed-logins" class="text-sm text-red-400">3</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-300">Suspicious Activity</span>
                  <span id="suspicious-activity" class="text-sm text-yellow-400">1</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-300">Security Alerts</span>
                  <span id="security-alerts" class="text-sm text-orange-400">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-300">Blocked IPs</span>
                  <span id="blocked-ips" class="text-sm text-purple-400">2</span>
                </div>
              </div>
            </div>

            <!-- Recent Security Events -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-gray-400 mb-3">Recent Security Events</h4>
              <div id="security-events" class="space-y-2 max-h-32 overflow-y-auto">
                <div class="text-xs text-green-400">âœ“ Login successful: admin@system</div>
                <div class="text-xs text-blue-400">â„¹ IP whitelist updated</div>
                <div class="text-xs text-yellow-400">âš  Multiple failed login attempts</div>
                <div class="text-xs text-red-400">âœ— Suspicious activity detected</div>
              </div>
            </div>

            <!-- Audit Log Summary -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-gray-400 mb-3">Audit Summary</h4>
              <div class="grid grid-cols-2 gap-2">
                <div class="bg-gray-900/30 p-2 rounded text-center">
                  <div class="text-lg font-bold text-green-400" id="audit-user-actions">1,247</div>
                  <div class="text-xs text-gray-400">User Actions</div>
                </div>
                <div class="bg-gray-900/30 p-2 rounded text-center">
                  <div class="text-lg font-bold text-blue-400" id="audit-admin-actions">89</div>
                  <div class="text-xs text-gray-400">Admin Actions</div>
                </div>
                <div class="bg-gray-900/30 p-2 rounded text-center">
                  <div class="text-lg font-bold text-yellow-400" id="audit-system-events">156</div>
                  <div class="text-xs text-gray-400">System Events</div>
                </div>
                <div class="bg-gray-900/30 p-2 rounded text-center">
                  <div class="text-lg font-bold text-purple-400" id="audit-security-events">23</div>
                  <div class="text-xs text-gray-400">Security Events</div>
                </div>
              </div>
            </div>

            <!-- Quick Security Actions -->
            <div>
              <h4 class="text-sm font-medium text-gray-400 mb-3">Quick Actions</h4>
              <div class="space-y-2">
                <button id="security-scan-btn" class="w-full bg-red-800/50 hover:bg-red-700/50 text-red-300 font-medium py-2 px-3 rounded-lg text-sm border border-red-700/50">
                  Run Security Scan
                </button>
                <button id="export-audit-log-btn" class="w-full bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-medium py-2 px-3 rounded-lg text-sm border border-purple-700/50">
                  Export Audit Log
                </button>
                <button id="clear-security-logs-btn" class="w-full bg-gray-800/50 hover:bg-gray-700/50 text-gray-300 font-medium py-2 px-3 rounded-lg text-sm border border-gray-700/50">
                  Clear Old Logs
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Management Section -->
        <div class="content-card p-6 mb-8">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-bold text-green-400">Content Management</h2>
              <p class="text-sm text-gray-400 mt-1">Manage courses, videos, and categories</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button id="refresh-content-btn" class="btn-secondary flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>Refresh Content</span>
              </button>
              <button id="bulk-update-content-btn" class="btn-secondary flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                <span>Bulk Update</span>
              </button>
            </div>
          </div>

          <!-- Content Overview -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="content-card p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-sm font-medium text-gray-400">Total Courses</h3>
                  <p class="text-2xl font-bold text-green-400" id="total-courses">0</p>
                </div>
                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
              </div>
            </div>

            <div class="content-card p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-sm font-medium text-gray-400">Total Videos</h3>
                  <p class="text-2xl font-bold text-blue-400" id="total-videos">0</p>
                </div>
                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </div>
              </div>
            </div>

            <div class="content-card p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-sm font-medium text-gray-400">Categories</h3>
                  <p class="text-2xl font-bold text-purple-400" id="total-categories">0</p>
                </div>
                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                  </svg>
                </div>
              </div>
            </div>

            <div class="content-card p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-sm font-medium text-gray-400">Storage Used</h3>
                  <p class="text-2xl font-bold text-yellow-400" id="storage-used">0 GB</p>
                </div>
                <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Management Tabs -->
          <div class="mb-6">
            <div class="flex space-x-1 bg-gray-900/30 p-1 rounded-lg">
              <button id="courses-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all duration-200 bg-green-600/20 text-green-300">
                Courses
              </button>
              <button id="videos-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all duration-200 text-gray-400 hover:text-gray-300">
                Videos
              </button>
              <button id="categories-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all duration-200 text-gray-400 hover:text-gray-300">
                Categories
              </button>
              <button id="media-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all duration-200 text-gray-400 hover:text-gray-300">
                Media
              </button>
            </div>
          </div>

          <!-- Content Tables -->
          <div id="courses-content" class="content-section">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-800/50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Course Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Videos</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Duration</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Views</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="courses-table-body" class="divide-y divide-gray-700/30">
                  <!-- Course rows will be populated here -->
                </tbody>
              </table>
            </div>
          </div>

          <div id="videos-content" class="content-section hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-800/50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Video Title</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Course</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Duration</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Size</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="videos-table-body" class="divide-y divide-gray-700/30">
                  <!-- Video rows will be populated here -->
                </tbody>
              </table>
            </div>
          </div>

          <div id="categories-content" class="content-section hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-800/50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Category Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Courses</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Videos</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Description</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="categories-table-body" class="divide-y divide-gray-700/30">
                  <!-- Category rows will be populated here -->
                </tbody>
              </table>
            </div>
          </div>

          <div id="media-content" class="content-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="content-card p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-2">Storage Overview</h4>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-300">Used</span>
                    <span class="text-green-400">2.4 GB</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-300">Available</span>
                    <span class="text-blue-400">7.6 GB</span>
                  </div>
                  <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" style="width: 24%"></div>
                  </div>
                </div>
              </div>
              <div class="content-card p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-2">File Types</h4>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-300">Videos</span>
                    <span class="text-purple-400">1.8 GB</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-300">Images</span>
                    <span class="text-yellow-400">0.4 GB</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-300">Other</span>
                    <span class="text-blue-400">0.2 GB</span>
                  </div>
                </div>
              </div>
              <div class="content-card p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-2">Optimization</h4>
                <div class="space-y-2">
                  <button class="w-full bg-blue-800/50 hover:bg-blue-700/50 text-blue-300 font-medium py-2 px-3 rounded-lg text-sm">
                    Compress Images
                  </button>
                  <button class="w-full bg-green-800/50 hover:bg-green-700/50 text-green-300 font-medium py-2 px-3 rounded-lg text-sm">
                    Optimize Videos
                  </button>
                  <button class="w-full bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-medium py-2 px-3 rounded-lg text-sm">
                    Clean Cache
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- API Management Section -->
        <div class="content-card p-6 mb-8">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-bold text-green-400">API Management</h2>
              <p class="text-sm text-gray-400 mt-1">Monitor and manage API endpoints</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button id="test-all-apis-btn" class="btn-secondary flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Test All APIs</span>
              </button>
              <button id="generate-api-docs-btn" class="btn-secondary flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>API Documentation</span>
              </button>
            </div>
          </div>

          <!-- API Endpoints Table -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-800/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Endpoint</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Method</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Response Time</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Requests/min</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Error Rate</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="api-endpoints-body" class="divide-y divide-gray-700/30">
                <!-- API endpoint rows will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Enhanced System Management -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

          <!-- System Settings & Tools -->
          <div class="content-card p-6">
            <h2 class="text-2xl font-bold text-green-400 mb-6">System Tools</h2>

            <!-- Backup & Restore -->
            <div class="mb-6">
              <h3 class="text-lg font-bold text-blue-400 mb-4">Backup & Restore</h3>
              <div class="space-y-3">
                <button id="create-backup-btn" class="w-full bg-blue-800/50 hover:bg-blue-700/50 text-blue-300 font-medium py-3 px-4 rounded-lg border border-blue-700/50">
                  Create System Backup
                </button>
                <button id="restore-backup-btn" class="w-full bg-yellow-800/50 hover:bg-yellow-700/50 text-yellow-300 font-medium py-3 px-4 rounded-lg border border-yellow-700/50">
                  Restore from Backup
                </button>
                <div class="text-xs text-gray-400">
                  Last backup: <span id="last-backup-time">Never</span>
                </div>
              </div>
            </div>

            <!-- Maintenance Tools -->
            <div class="mb-6">
              <h3 class="text-lg font-bold text-purple-400 mb-4">Maintenance</h3>
              <div class="space-y-3">
                <button id="cleanup-sessions-btn" class="w-full bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-medium py-3 px-4 rounded-lg border border-purple-700/50">
                  Cleanup Expired Sessions
                </button>
                <button id="optimize-kv-btn" class="w-full bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-medium py-3 px-4 rounded-lg border border-purple-700/50">
                  Optimize KV Storage
                </button>
                <button id="clear-cache-btn" class="w-full bg-red-800/50 hover:bg-red-700/50 text-red-300 font-medium py-3 px-4 rounded-lg border border-red-700/50">
                  Clear System Cache
                </button>
                <button id="cleanup-expired-btn" class="w-full bg-orange-800/50 hover:bg-orange-700/50 text-orange-300 font-medium py-3 px-4 rounded-lg border border-orange-700/50">
                  Cleanup Expired Data
                </button>
              </div>
            </div>

            <!-- System Configuration -->
            <div>
              <h3 class="text-lg font-bold text-green-400 mb-4">Configuration</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold text-gray-400 mb-2">Max Users</label>
                  <input type="number" id="max-users-input" value="1000" class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-400 mb-2">Session Timeout (minutes)</label>
                  <input type="number" id="session-timeout-input" value="60" class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-400 mb-2">Max Login Attempts</label>
                  <input type="number" id="max-login-attempts-input" value="5" class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500">
                </div>
                <button id="save-settings-btn" class="w-full btn-primary py-3 font-bold mt-4">
                  Save Configuration
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- VIEW USER MODAL FIX: Added new modal for viewing and editing user details -->
    <div
      id="view-user-modal"
      class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-black border border-green-700/50 rounded-lg shadow-lg shadow-green-500/10 w-full max-w-lg"
      >
        <header
          class="p-4 border-b border-green-900/50 flex justify-between items-center"
        >
          <h2 class="text-xl font-bold text-green-400">[User Details]</h2>
          <button
            onclick="hideUserDetailsModal()"
            class="text-gray-500 hover:text-red-400 text-2xl"
          >
            &times;
          </button>
        </header>
        <div class="p-6 space-y-4" id="view-user-modal-content">
          <!-- User details will be populated here -->
        </div>
      </div>
    </div>

    <!-- Generate Code Modal -->
    <div
      id="generate-code-modal"
      class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-black border border-green-700/50 rounded-lg shadow-lg shadow-green-500/10 w-full max-w-md"
      >
        <header class="p-4 border-b border-green-900/50">
          <h2 class="text-xl font-bold text-green-400">
            [Generate Activation Code]
          </h2>
        </header>
        <div class="p-6 space-y-4">
          <form id="generate-code-form" class="space-y-4">
            <div>
              <label
                for="code-expiry"
                class="block text-sm font-bold text-green-500 mb-2"
              >
                > Expiry Days (1-30)
              </label>
              <input
                type="number"
                id="code-expiry"
                min="1"
                max="30"
                value="7"
                required
                class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
              />
            </div>
            <div>
              <label
                for="code-quantity"
                class="block text-sm font-bold text-green-500 mb-2"
              >
                > Quantity
              </label>
              <input
                type="number"
                id="code-quantity"
                min="1"
                max="100"
                value="1"
                required
                class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
              />
            </div>
            <button type="submit" class="w-full btn-primary py-3 font-bold">
              [Generate Codes]
            </button>
          </form>

          <!-- Generated Codes Display Section -->
          <div id="generated-codes-section" class="hidden space-y-4 mt-6">
            <div class="border-t border-green-900/50 pt-4">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-green-400">
                  Generated Codes
                </h3>
                <button
                  onclick="copyGeneratedCodes()"
                  class="btn-primary px-4 py-2 text-sm font-medium"
                >
                  [COPY ALL]
                </button>
              </div>
              <div
                id="generated-codes-display"
                class="bg-gray-900/30 border border-green-800/30 rounded-md p-4 max-h-60 overflow-y-auto text-sm text-green-300 font-mono whitespace-pre-line"
              >
                <!-- Generated codes will be displayed here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Announcement Modal -->
    <div
      id="announcement-modal"
      class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-black border border-green-700/50 rounded-lg shadow-lg shadow-green-500/10 w-full max-w-md"
      >
        <header class="p-4 border-b border-green-900/50">
          <h2 class="text-xl font-bold text-green-400">
            Create Announcement
          </h2>
        </header>
        <div class="p-6 space-y-4">
          <form id="announcement-form-modal" class="space-y-4">
            <div>
              <label
                for="modal-announcement-title"
                class="block text-sm font-bold text-green-500 mb-2"
              >
                > Title
              </label>
              <input
                type="text"
                id="modal-announcement-title"
                required
                class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
                placeholder="Announcement title"
              />
            </div>
            <div>
              <label
                for="modal-announcement-content"
                class="block text-sm font-bold text-green-500 mb-2"
              >
                > Content
              </label>
              <textarea
                id="modal-announcement-content"
                required
                rows="4"
                class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
                placeholder="Announcement content"
              ></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  for="modal-announcement-type"
                  class="block text-sm font-bold text-green-500 mb-2"
                >
                  > Type
                </label>
                <select
                  id="modal-announcement-type"
                  class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
                >
                  <option value="info">Info</option>
                  <option value="success">Success</option>
                  <option value="warning">Warning</option>
                  <option value="error">Error</option>
                </select>
              </div>
              <div>
                <label
                  for="modal-announcement-priority"
                  class="block text-sm font-bold text-green-500 mb-2"
                >
                  > Priority
                </label>
                <select
                  id="modal-announcement-priority"
                  class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
                >
                  <option value="low">Low</option>
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
            </div>
            <div>
              <label
                for="modal-announcement-expires"
                class="block text-sm font-bold text-green-500 mb-2"
              >
                > Expires At (Optional)
              </label>
              <input
                type="datetime-local"
                id="modal-announcement-expires"
                class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
              />
            </div>
            <button type="submit" class="w-full btn-primary py-3 font-bold">
              [Create Announcement]
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Extend Access Modal -->
    <div
      id="extend-access-modal"
      class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-black border border-green-700/50 rounded-lg shadow-lg shadow-green-500/10 w-full max-w-md"
      >
        <header class="p-4 border-b border-green-900/50">
          <h2 class="text-xl font-bold text-green-400">
            Extend User Access
          </h2>
        </header>
        <div class="p-6 space-y-4">
          <div id="selected-users-info" class="text-sm text-gray-300">
            Select users from the table to extend their access.
          </div>

          <div class="space-y-3">
            <h3 class="text-sm font-bold text-green-400">Quick Options:</h3>
            <div class="grid grid-cols-2 gap-3">
              <button
                onclick="extendSelectedUsersAccess(30)"
                class="bg-green-800/50 hover:bg-green-700/50 text-green-300 font-medium py-3 px-4 rounded-lg border border-green-700/50"
              >
                +30 Days
              </button>
              <button
                onclick="extendSelectedUsersAccess(60)"
                class="bg-blue-800/50 hover:bg-blue-700/50 text-blue-300 font-medium py-3 px-4 rounded-lg border border-blue-700/50"
              >
                +60 Days
              </button>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button
                onclick="extendSelectedUsersAccess(90)"
                class="bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-medium py-3 px-4 rounded-lg border border-purple-700/50"
              >
                +90 Days
              </button>
              <button
                onclick="extendSelectedUsersAccess(365)"
                class="bg-yellow-800/50 hover:bg-yellow-700/50 text-yellow-300 font-medium py-3 px-4 rounded-lg border border-yellow-700/50"
              >
                +1 Year
              </button>
            </div>
          </div>

          <div class="border-t border-gray-700/50 pt-4">
            <h3 class="text-sm font-bold text-green-400 mb-3">Custom Extension:</h3>
            <div class="flex space-x-2">
              <input
                type="number"
                id="custom-extension-days"
                min="1"
                max="3650"
                placeholder="Days"
                class="flex-1 bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500"
              />
              <button
                onclick="extendSelectedUsersAccess(parseInt(document.getElementById('custom-extension-days').value))"
                class="bg-green-800/50 hover:bg-green-700/50 text-green-300 font-medium py-3 px-4 rounded-lg border border-green-700/50"
              >
                Extend
              </button>
            </div>
          </div>

          <div class="flex justify-end space-x-4 pt-4">
            <button
              onclick="hideExtendAccessModal()"
              class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="auth.js"></script>
    <script>
      const WORKER_URL = "https://compute.anyme.workers.dev";

      // Enhanced dashboard state management
      let allUsers = [];
      let allCodes = [];
      let systemMetrics = {
        startTime: Date.now(),
        apiCalls: 0,
        errors: 0,
        lastHealthCheck: null
      };
      let activityLogs = [];

      // Announcement DOM elements (global scope)
      let createAnnouncementBtn, announcementModal, announcementForm, announcementFormModal, announcementsList;

      // Admin-specific functions
      function showGenerateCodeModal() {
        const modal = document.getElementById("generate-code-modal");
        if (modal) modal.classList.remove("hidden");
      }

      // Function to update analytics displays with numbers
      function updateAnalyticsDisplays(users, codes) {
        if (!users || !codes) return;

        // User analytics
        const now = new Date();
        const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

        const weeklyUsers = users.filter(user => new Date(user.created_at) > sevenDaysAgo).length;
        const monthlyUsers = users.filter(user => new Date(user.created_at) > thirtyDaysAgo).length;
        const avgDaily = Math.round(monthlyUsers / 30);
        const growthRate = monthlyUsers > 0 ? Math.round((weeklyUsers / (monthlyUsers / 4)) * 100 - 100) : 0;

        // Code analytics
        const activeCodes = codes.filter(code => !code.used && new Date(code.expires_at) > now).length;
        const usedCodes = codes.filter(code => code.used).length;
        const expiredCodes = codes.filter(code => new Date(code.expires_at) < now).length;
        const utilizationRate = codes.length > 0 ? Math.round((usedCodes / codes.length) * 100) : 0;

        // Activity analytics
        const todayLogins = users.filter(user => {
          if (!user.last_seen) return false;
          const lastSeen = new Date(user.last_seen);
          return lastSeen.toDateString() === now.toDateString();
        }).length;

        const weekLogins = users.filter(user => {
          if (!user.last_seen) return false;
          return new Date(user.last_seen) > sevenDaysAgo;
        }).length;

        const monthLogins = users.filter(user => {
          if (!user.last_seen) return false;
          return new Date(user.last_seen) > thirtyDaysAgo;
        }).length;

        // Peak hour calculation (simplified)
        const peakHour = Math.floor(Math.random() * 24); // This would be calculated from actual data

        // Update DOM elements safely
        const analyticsData = [
          { id: "weekly-users", value: weeklyUsers },
          { id: "monthly-users", value: monthlyUsers },
          { id: "growth-rate", value: `${growthRate >= 0 ? '+' : ''}${growthRate}%` },
          { id: "avg-daily", value: avgDaily },
          { id: "active-codes", value: activeCodes },
          { id: "used-codes", value: usedCodes },
          { id: "expired-codes", value: expiredCodes },
          { id: "utilization-rate", value: `${utilizationRate}%` },
          { id: "today-logins", value: todayLogins },
          { id: "week-logins", value: weekLogins },
          { id: "month-logins", value: monthLogins },
          { id: "peak-hour", value: `${peakHour}:00` }
        ];

        analyticsData.forEach(({ id, value }) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        });
      }

      // IMPERSONATION FIX: Use the enhanced impersonation function from auth.js
      // The impersonateUser function is now handled by auth.js for better consistency

      function hideGenerateCodeModal() {
        const modal = document.getElementById("generate-code-modal");
        if (modal) {
          modal.classList.add("hidden");
          const generatedCodesSection = document.getElementById(
            "generated-codes-section"
          );
          if (generatedCodesSection) {
            generatedCodesSection.classList.add("hidden");
          }
        }
      }

      // VIEW USER MODAL FIX: Functions to show/hide the new modal (global scope)
      function hideUserDetailsModal() {
        const modal = document.getElementById("view-user-modal");
        if (modal) modal.classList.add("hidden");
      }

      //Function to update user details (expiry date and role)

      async function updateUserDetails(email) { // (global scope)
        const newRole = document.getElementById("user-role-select").value;
        const expiryDateInput = document.getElementById("user-expiry-date");

        const isSpecialRole = newRole === "admin" || newRole === "supreme";

        let updates = {
          role: newRole,
        };

        if (isSpecialRole) {
          // For admin/supreme, always set expiry to null to remove it.
          updates.expires_at = null;
        } else {
          // For regular users, an expiry date is required.
          if (!expiryDateInput.value) {
            showNotification(
              "A regular user must have an expiry date.",
              "error"
            );
            return;
          }
          updates.expires_at = new Date(expiryDateInput.value).toISOString();
        }

        try {
          const response = await fetch(`${WORKER_URL}?action=update_user`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: email,
              updates: updates,
            }),
          });

          if (!response.ok) throw new Error("Update failed");

          showNotification("User details updated successfully!", "success");
          hideUserDetailsModal();
          loadAdminData();
        } catch (error) {
          showNotification(`Error: ${error.message}`, "error");
        }
      }

      function showUserDetails(user) {
        const modal = document.getElementById("view-user-modal");
        const content = document.getElementById("view-user-modal-content");
        if (!modal || !content) return;

        // Determine if the role is special (non-expiring)
        const isSpecialRole = user.role === "admin" || user.role === "supreme";

        // Set expiry to empty if it doesn't exist, and disable if the role is special
        const expiryDate = user.expires_at
          ? new Date(user.expires_at).toISOString().split("T")[0]
          : "";
        const dateInputDisabled = isSpecialRole ? "disabled" : "";

        content.innerHTML = `
              <div class="space-y-4">
                  <div>
                      <label class="block text-sm font-bold text-gray-400">Name</label>
                      <p class="text-green-300">${user.name}</p>
                  </div>
                  <div>
                      <label class="block text-sm font-bold text-gray-400">Email</label>
                      <p class="text-green-300">${user.email}</p>
                  </div>
                  <div>
                      <label class="block text-sm font-bold text-gray-400 mb-2">User Type</label>
                      <div class="mb-3">
                          <span class="px-3 py-1 text-sm font-medium rounded-full ${
                            user.role === "admin"
                              ? "bg-red-600/20 text-red-300 border border-red-600/30"
                              : user.role === "supreme"
                              ? "bg-purple-600/20 text-purple-300 border border-purple-600/30"
                              : "bg-blue-600/20 text-blue-300 border border-blue-600/30"
                          }">
                            ${user.role === "supreme" ? "Medcrunch Supreme" : user.role === "admin" ? "Admin" : "User"}
                          </span>
                      </div>
                      <label for="user-role-select" class="block text-sm font-bold text-gray-400 mb-2">Change Role</label>
                      <select id="user-role-select" class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500">
                          <option value="user">User</option>
                          <option value="supreme">Medcrunch Supreme</option>
                          <option value="admin">Admin</option>
                      </select>
                  </div>
                  <div>
                      <label for="user-expiry-date" class="block text-sm font-bold text-gray-400 mb-2">Expires At</label>
                      <input type="date" id="user-expiry-date" value="${expiryDate}" ${dateInputDisabled} class="w-full bg-gray-900/50 border border-green-800/50 rounded-md p-3 text-green-300 focus:outline-none focus:ring-1 focus:ring-green-500 disabled:bg-gray-800/50 disabled:cursor-not-allowed">
                      ${
                        isSpecialRole
                          ? '<p class="text-xs text-yellow-400 mt-1">Expiry date is disabled for Admin and Supreme roles.</p>'
                          : ""
                      }
                  </div>
                  <div class="border-t border-gray-700/50 pt-4">
                      <h3 class="text-sm font-bold text-green-400 mb-3">Quick Access Extension:</h3>
                      <div class="grid grid-cols-2 gap-2 mb-4">
                          <button onclick="extendUserAccessFromModal('${user.email}', 30)" class="bg-green-800/50 hover:bg-green-700/50 text-green-300 font-medium py-2 px-3 rounded-md text-sm">
                              +30 Days
                          </button>
                          <button onclick="extendUserAccessFromModal('${user.email}', 60)" class="bg-blue-800/50 hover:bg-blue-700/50 text-blue-300 font-medium py-2 px-3 rounded-md text-sm">
                              +60 Days
                          </button>
                          <button onclick="extendUserAccessFromModal('${user.email}', 90)" class="bg-purple-800/50 hover:bg-purple-700/50 text-purple-300 font-medium py-2 px-3 rounded-md text-sm">
                              +90 Days
                          </button>
                          <button onclick="extendUserAccessFromModal('${user.email}', 365)" class="bg-yellow-800/50 hover:bg-yellow-700/50 text-yellow-300 font-medium py-2 px-3 rounded-md text-sm">
                              +1 Year
                          </button>
                      </div>
                  </div>
                  <div class="flex justify-end space-x-4 pt-4 border-t border-gray-700/50">
                      <button onclick="hideUserDetailsModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">[Cancel]</button>
                      <button onclick="updateUserDetails('${user.email}')" class="btn-primary py-2 px-4 text-sm">[Save Changes]</button>
                  </div>
              </div>
            `;

        document.getElementById("user-role-select").value = user.role;
        modal.classList.remove("hidden");
      }

      async function updateUserExpiry(email) {
        const newExpiryDate = document.getElementById("user-expiry-date").value;
        if (!newExpiryDate) {
          showNotification("Please select a valid date.", "error");
          return;
        }

        // Convert YYYY-MM-DD to full ISO string for storage
        const expiryISOString = new Date(newExpiryDate).toISOString();

        try {
          const response = await fetch(`${WORKER_URL}?action=update_user`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: email,
              updates: { expires_at: expiryISOString },
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Update failed");
          }

          showNotification("User expiry date updated successfully!", "success");
          hideUserDetailsModal();
          loadAdminData(); // Refresh the data to show the change
        } catch (error) {
          showNotification(`Error: ${error.message}`, "error");
        }
      }

      // Enhanced system monitoring
      function updateSystemMetrics() {
        const uptime = Math.floor((Date.now() - systemMetrics.startTime) / 1000);
        const hours = Math.floor(uptime / 3600);
        const minutes = Math.floor((uptime % 3600) / 60);
        const seconds = uptime % 60;

        document.getElementById("last-update").textContent =
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // Simulate realistic system metrics
        const cpuUsage = Math.random() * 30 + 10; // 10-40%
        const memoryUsage = Math.random() * 40 + 30; // 30-70%

        document.getElementById("cpu-usage-bar").style.width = `${cpuUsage}%`;
        document.getElementById("cpu-usage-text").textContent = `${Math.round(cpuUsage)}%`;
        document.getElementById("memory-usage-bar").style.width = `${memoryUsage}%`;
        document.getElementById("memory-usage-text").textContent = `${Math.round(memoryUsage)}%`;

        // Update system load indicator
        const loadPercent = (cpuUsage + memoryUsage) / 2;
        document.getElementById("system-load").textContent = `${Math.round(loadPercent)}%`;

        const loadStatus = loadPercent < 30 ? "Optimal" : loadPercent < 70 ? "Moderate" : "High";
        document.getElementById("load-status").textContent = loadStatus;

        // Update API health
        const avgResponse = Math.random() * 50 + 20; // 20-70ms
        document.getElementById("api-health").textContent = `${Math.round(avgResponse)}ms`;
        document.getElementById("api-response").textContent = `${Math.round(avgResponse)}ms`;
      }


      // Add activity log entry
      function addActivityLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = {
          timestamp,
          message,
          type
        };

        activityLogs.unshift(logEntry);
        if (activityLogs.length > 50) activityLogs.pop(); // Keep only last 50 entries

        updateActivityDisplay();
      }

      // Update activity display
      function updateActivityDisplay() {
        const activityContainer = document.getElementById("recent-activity");
        if (!activityContainer) return;

        if (activityLogs.length === 0) {
          activityContainer.innerHTML = '<div class="text-sm text-gray-400 italic">No recent activity</div>';
          return;
        }

        activityContainer.innerHTML = activityLogs.map(log => `
          <div class="flex items-start space-x-2 text-sm">
            <span class="text-xs text-gray-500">${log.timestamp}</span>
            <span class="text-${log.type === 'error' ? 'red' : log.type === 'warning' ? 'yellow' : 'green'}-400 flex-1">
              ${log.message}
            </span>
          </div>
        `).join("");
      }

      // Enhanced system health check
      async function performHealthCheck() {
        addActivityLog("Starting system health check...", "info");

        try {
          const startTime = Date.now();

          // Test various endpoints
          const endpoints = [
            { name: "Categories API", url: `${WORKER_URL}?view=categories` },
            { name: "Auth Check", url: `${WORKER_URL}?action=get_users` },
            { name: "KV Storage", url: `${WORKER_URL}?action=get_codes` }
          ];

          let allHealthy = true;
          const results = [];

          for (const endpoint of endpoints) {
            try {
              const response = await fetch(endpoint.url);
              const responseTime = Date.now() - startTime;
              results.push(`${endpoint.name}: ${response.ok ? 'âœ“' : 'âœ—'} (${responseTime}ms)`);

              if (!response.ok) allHealthy = false;
            } catch (error) {
              results.push(`${endpoint.name}: âœ— (Failed)`);
              allHealthy = false;
            }
          }

          const totalTime = Date.now() - startTime;
          systemMetrics.lastHealthCheck = new Date();

          if (allHealthy) {
            addActivityLog(`Health check completed successfully in ${totalTime}ms`, "success");
            showNotification("All systems operational", "success");
          } else {
            addActivityLog(`Health check completed with issues in ${totalTime}ms`, "warning");
            showNotification("Some systems may have issues", "warning");
          }

          // Update system logs display
          updateSystemLogs(results);

        } catch (error) {
          addActivityLog(`Health check failed: ${error.message}`, "error");
          showNotification("Health check failed", "error");
        }
      }

      // Update system logs display
      function updateSystemLogs(results) {
        const logsContainer = document.getElementById("system-logs");
        if (!logsContainer) return;

        const timestamp = new Date().toLocaleTimeString();
        logsContainer.innerHTML = results.map(result =>
          `<div class="text-${result.includes('âœ“') ? 'green' : 'red'}-400">[${timestamp}] ${result}</div>`
        ).join("");
      }

      // Load build number from worker API (standalone function)
      async function loadBuildNumber() {
        const buildElement = document.getElementById("current-build");

        try {
          const response = await fetch(`${WORKER_URL}?action=get_build`);
          if (response.ok) {
            const buildData = await response.json();
            const buildNo = buildData.build_no || buildData.working_build_no || "521";
            if (buildElement) buildElement.textContent = buildNo;
            addActivityLog(`Current build number: ${buildNo}`, "info");
          } else {
            if (buildElement) buildElement.textContent = "521";
          }
        } catch (error) {
          console.log("Build info not available, using default");
          if (buildElement) buildElement.textContent = "521";
        }
      }

      // Load admin data with enhanced functionality
      async function loadAdminData() {
        try {
          addActivityLog("Loading admin dashboard data...", "info");

          // Load users
          const usersResponse = await fetch(`${WORKER_URL}?action=get_users`);
          if (usersResponse.ok) {
            const usersData = await usersResponse.json();
            allUsers = usersData.users || [];
            updateUserStats(allUsers);
            addActivityLog(`Loaded ${allUsers.length} users`, "success");
          } else {
            allUsers = [];
            updateUserStats([]);
            addActivityLog("Failed to load user data", "error");
            showNotification("Failed to load user data", "error");
          }

          // Load activation codes
          const codesResponse = await fetch(`${WORKER_URL}?action=get_codes`);
          if (codesResponse.ok) {
            const codesData = await codesResponse.json();
            allCodes = codesData.codes || [];
            updateCodeStats(allCodes);
            addActivityLog(`Loaded ${allCodes.length} activation codes`, "success");
          } else {
            allCodes = [];
            updateCodeStats([]);
            addActivityLog("Failed to load activation codes", "error");
            showNotification("Failed to load activation codes", "error");
          }

          // Update analytics displays and data
          if (allUsers && allCodes) {
            updateAnalyticsDisplays(allUsers, allCodes);
          }
          renderFilteredData();

          // Load announcements
          loadAnnouncements();

          addActivityLog("Admin dashboard loaded successfully", "success");

        } catch (error) {
          console.error("Admin data error:", error);
          addActivityLog(`Failed to load admin data: ${error.message}`, "error");
          showNotification("Failed to load admin data", "error");
          allUsers = [];
          allCodes = [];
          updateUserStats([]);
          updateCodeStats([]);
          renderFilteredData();
        }
      }

      // Enhanced filtering with multiple criteria
      function renderFilteredData() {
        let filteredUsers = [...allUsers];
        let filteredCodes = [...allCodes];

        // User filters
        const userSearchTerm = document.getElementById("user-search").value.toLowerCase();
        const userStatusFilter = document.getElementById("user-status-filter").value;
        const userRoleFilter = document.getElementById("user-role-filter").value;
        const userSortFilter = document.getElementById("user-sort-filter").value;

        // Apply search filter
        if (userSearchTerm) {
          filteredUsers = filteredUsers.filter(
            (user) =>
              user.name.toLowerCase().includes(userSearchTerm) ||
              user.email.toLowerCase().includes(userSearchTerm) ||
              user.role.toLowerCase().includes(userSearchTerm)
          );
        }

        // Apply status filter
        if (userStatusFilter !== "all") {
          filteredUsers = filteredUsers.filter((user) => {
            const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
            const isOnline = user.last_seen && new Date(user.last_seen) > tenMinutesAgo;

            switch (userStatusFilter) {
              case "online":
                return isOnline;
              case "active":
                return user.role !== "admin" && (!user.expires_at || new Date(user.expires_at) > new Date());
              case "inactive":
                return !isOnline;
              case "expired":
                return user.expires_at && new Date(user.expires_at) < new Date();
              case "admin":
                return user.role === "admin";
              default:
                return true;
            }
          });
        }

        // Apply role filter
        if (userRoleFilter !== "all") {
          filteredUsers = filteredUsers.filter((user) => user.role === userRoleFilter);
        }

        // Apply sorting
        filteredUsers.sort((a, b) => {
          switch (userSortFilter) {
            case "created_at_desc":
              return new Date(b.created_at) - new Date(a.created_at);
            case "created_at_asc":
              return new Date(a.created_at) - new Date(b.created_at);
            case "name_asc":
              return a.name.localeCompare(b.name);
            case "name_desc":
              return b.name.localeCompare(a.name);
            case "last_seen_desc":
              const aLastSeen = a.last_seen ? new Date(a.last_seen) : new Date(0);
              const bLastSeen = b.last_seen ? new Date(b.last_seen) : new Date(0);
              return bLastSeen - aLastSeen;
            default:
              return 0;
          }
        });

        // Code filters
        const codeSearchTerm = document.getElementById("code-search").value.toLowerCase();
        const codeStatusFilter = document.getElementById("code-status-filter").value;

        if (codeSearchTerm) {
          filteredCodes = filteredCodes.filter((code) =>
            code.code.toLowerCase().includes(codeSearchTerm)
          );
        }

        if (codeStatusFilter !== "all") {
          filteredCodes = filteredCodes.filter((code) => {
            const isExpired = new Date(code.expires_at) < new Date();
            const isUsed = code.used;

            switch (codeStatusFilter) {
              case "active":
                return !isUsed && !isExpired;
              case "used":
                return isUsed;
              case "expired":
                return isExpired;
              default:
                return true;
            }
          });
        }

        populateUsersTable(filteredUsers);
        populateCodesTable(filteredCodes);
      }

      function updateUserStats(users) {
        if (!users) return;

        const totalUsers = users.length;

        // Online users (currently online - based on last activity within 10 minutes)
        const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
        const onlineUsers = users.filter((user) => {
          if (!user.last_seen) return false;
          return new Date(user.last_seen) > tenMinutesAgo;
        }).length;

        // Active users (have logged in within last 7 days)
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const activeUsers = users.filter((user) => {
          if (!user.last_seen) return false;
          return new Date(user.last_seen) > sevenDaysAgo;
        }).length;

        // Enhanced stats calculation
        const adminUsers = users.filter(user => user.role === "admin").length;
        const regularUsers = totalUsers - adminUsers;
        const expiredUsers = users.filter(user => {
          if (user.role === "admin") return false;
          return user.expires_at && new Date(user.expires_at) < new Date();
        }).length;

        // Update DOM elements safely
        const elements = [
          { id: "total-users", value: totalUsers },
          { id: "online-users", value: onlineUsers },
          { id: "active-users", value: activeUsers },
          { id: "user-growth", value: `+${Math.floor(Math.random() * 15 + 5)}%` },
          { id: "active-rate", value: `${Math.round((activeUsers / totalUsers) * 100) || 0}%` }
        ];

        elements.forEach(({ id, value }) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        });

        // Update user growth rate (simulated)
        const growthElement = document.getElementById("user-growth");
        if (growthElement) {
          const growthRate = Math.floor(Math.random() * 20 + 5); // 5-25% growth
          growthElement.textContent = `+${growthRate}%`;
        }

        // Update active rate
        const activeRateElement = document.getElementById("active-rate");
        if (activeRateElement) {
          const activeRate = totalUsers > 0 ? Math.round((activeUsers / totalUsers) * 100) : 0;
          activeRateElement.textContent = `${activeRate}%`;
        }

        // Update code usage rate
        const codeUsageElement = document.getElementById("code-usage");
        if (codeUsageElement && allCodes) {
          const usedCodes = allCodes.filter(code => code.used).length;
          const usageRate = allCodes.length > 0 ? Math.round((usedCodes / allCodes.length) * 100) : 0;
          codeUsageElement.textContent = `${usageRate}%`;
        }
      }

      function updateCodeStats(codes) {
        if (!codes) return;

        const pendingCodes = codes.filter(
          (code) => !code.used && new Date(code.expires_at) > new Date()
        ).length;

        const expiredCodes = codes.filter(
          (code) => new Date(code.expires_at) < new Date()
        ).length;

        const usedCodes = codes.filter((code) => code.used).length;

        // Update DOM elements safely
        const elements = [
          { id: "pending-codes", value: pendingCodes }
        ];

        elements.forEach(({ id, value }) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        });

        // Update code usage rate
        const codeUsageElement = document.getElementById("code-usage");
        if (codeUsageElement) {
          const usageRate = codes.length > 0 ? Math.round((usedCodes / codes.length) * 100) : 0;
          codeUsageElement.textContent = `${usageRate}%`;
        }
      }

      function populateUsersTable(users) {
        const tbody = document.getElementById("users-table-body");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!users || users.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                No users found.
              </td>
            </tr>
          `;
          return;
        }

        users.forEach((user) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-800/30 transition-colors duration-200";

          const joinedDate = new Date(user.created_at).toLocaleDateString();
          const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
          const isOnline = user.last_seen && new Date(user.last_seen) > tenMinutesAgo;
          const status =
            user.role === "admin" ? "Admin" : isOnline ? "Online" : "Offline";

          // EXPIRY DATE FIX: Logic to format and color the expiry date

          let expiryHtml;
          // If the role is admin or supreme, always show N/A.
          if (user.role === "admin" || user.role === "supreme") {
            expiryHtml = '<span class="text-gray-500">N/A</span>';
          } else if (user.expires_at) {
            // Otherwise, for regular users, calculate and display the expiry date.
            const expiryDate = new Date(user.expires_at);
            const now = new Date();
            const sevenDaysFromNow = new Date(
              now.getTime() + 7 * 24 * 60 * 60 * 1000
            );

            let colorClass = "text-gray-300";
            if (expiryDate < now) {
              colorClass = "text-red-400 font-bold"; // Expired
            } else if (expiryDate < sevenDaysFromNow) {
              colorClass = "text-yellow-400"; // Expiring soon
            }
            expiryHtml = `<span class="${colorClass}">${expiryDate.toLocaleDateString()}</span>`;
          } else {
            // Fallback for a regular user with no expiry date set
            expiryHtml = '<span class="text-red-500 font-bold">MISSING</span>';
          }

          row.innerHTML = `
            <!-- BULK ACTIONS FIX: Added checkbox for each user -->
            <td class="px-4 py-4">
                <input type="checkbox" class="user-checkbox bg-gray-700 border-gray-600 rounded" data-email="${
                  user.email
                }">
            </td>
            <td class="px-4 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="w-8 h-8 ${
                  user.role === "admin"
                    ? "bg-red-600"
                    : isOnline
                    ? "bg-green-600"
                    : "bg-gray-600"
                } rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                  <span class="text-sm font-bold text-white">${user.name
                    .charAt(0)
                    .toUpperCase()}</span>
                </div>
                <div class="min-w-0 flex-1">
                  <div class="text-sm font-medium text-white truncate">${user.name}</div>
                  <div class="text-xs text-gray-400 flex items-center gap-2 mt-0.5">
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full flex-shrink-0 ${
                      user.role === "admin"
                        ? "bg-red-600/30 text-red-300 border border-red-600/50"
                        : user.role === "supreme"
                        ? "bg-purple-600/30 text-purple-300 border border-purple-600/50"
                        : "bg-blue-600/30 text-blue-300 border border-blue-600/50"
                    }">
                      ${user.role === "supreme" ? "SUPREME" : user.role.toUpperCase()}
                    </span>
                    <span class="truncate">${user.email}</span>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-4 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${
                user.role === "admin"
                  ? "bg-red-600/20 text-red-300 border border-red-600/30"
                  : isOnline
                  ? "bg-green-600/20 text-green-300 border border-green-600/30"
                  : "bg-gray-600/20 text-gray-300 border border-gray-600/30"
              }">
                ${status}
              </span>
            </td>
            <!-- EXPIRY DATE FIX: Added new table cell -->
            <td class="px-4 py-4 whitespace-nowrap text-sm">${expiryHtml}</td>
            <td class="hidden md:table-cell px-4 py-4 whitespace-nowrap text-sm text-gray-300">${joinedDate}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
              <button class="text-blue-400 hover:text-blue-300 mr-2" onclick='showUserDetails(${JSON.stringify(
                user
              )})'>[View]</button>
              <button class="text-yellow-400 hover:text-yellow-300 mr-2" onclick="impersonateUser('${
                user.email
              }')">[Login As]</button>
              ${
                user.role !== "admin"
                  ? `<button class="text-red-400 hover:text-red-300" onclick="deleteUser('${user.email}')">[Delete]</button>`
                  : ""
              }
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      function populateCodesTable(codes) {
        const tbody = document.getElementById("codes-table-body");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!codes || codes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                No activation codes found.
              </td>
            </tr>
          `;
          return;
        }

        codes.forEach((code) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-800/30 transition-colors duration-200";

          const expiresDate = new Date(code.expires_at).toLocaleDateString();
          const isExpired = new Date(code.expires_at) < new Date();
          const isUsed = code.used;

          let status = "Active";
          let statusClass =
            "bg-green-600/20 text-green-300 border border-green-600/30";

          if (isUsed) {
            status = "Used";
            statusClass =
              "bg-blue-600/20 text-blue-300 border border-blue-600/30";
          } else if (isExpired) {
            status = "Expired";
            statusClass = "bg-red-600/20 text-red-300 border border-red-600/30";
          }

          row.innerHTML = `
            <td class="px-4 py-4 whitespace-nowrap">
              <code class="text-sm font-mono text-green-300 bg-gray-800/50 px-2 py-1 rounded">
                ${code.code}
              </code>
            </td>
            <td class="px-4 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                ${status}
              </span>
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-300">${expiresDate}</td>
            <td class="hidden md:table-cell px-4 py-4 whitespace-nowrap text-sm text-gray-300">
              ${code.used_by || "Not used"}
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
              <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="copyCode('${
                code.code
              }')">[Copy]</button>
              ${
                !isUsed && !isExpired
                  ? `<button class="text-red-400 hover:text-red-300" onclick="deleteCode('${code.code}')">[Delete]</button>`
                  : ``
              }
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      // DELETE USER FIX: Make delete function work (global scope)
      async function deleteUser(email) {
        if (
          !confirm(
            `Are you sure you want to delete the user: ${email}? This action cannot be undone.`
          )
        ) {
          return;
        }
        try {
          const response = await fetch(`${WORKER_URL}?action=delete_user`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Deletion failed");
          }
          showNotification("User deleted successfully!", "success");
          loadAdminData(); // Refresh the user list
        } catch (error) {
          showNotification(`Error: ${error.message}`, "error");
        }
      }

      function copyCode(code) { // (global scope)
        navigator.clipboard
          .writeText(code)
          .then(() => {
            showNotification("Code copied to clipboard!", "success");
          })
          .catch(() => {
            showNotification("Failed to copy code", "error");
          });
      }

      async function deleteCode(code) { // (global scope)
        if (
          !confirm(
            `Are you sure you want to delete the activation code: ${code}?`
          )
        ) {
          return;
        }

        try {
          const response = await fetch(
            `${WORKER_URL}?action=delete_activation_code`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ code: code }),
            }
          );

          if (response.ok) {
            const result = await response.json();
            showNotification(
              "Activation code deleted successfully!",
              "success"
            );
            // Reload the admin data to refresh the table
            loadAdminData();
          } else {
            const error = await response.json();
            showNotification(`Failed to delete code: ${error.error}`, "error");
          }
        } catch (error) {
          console.error("Delete code error:", error);
          showNotification("Failed to delete activation code", "error");
        }
      }

      function copyAllCodes() { // (global scope)
        const codesTableBody = document.getElementById("codes-table-body");
        if (!codesTableBody) {
          showNotification("No codes table found", "error");
          return;
        }

        const codeRows = codesTableBody.querySelectorAll("tr");
        if (codeRows.length === 0) {
          showNotification("No codes available to copy", "error");
          return;
        }

        let allCodes = "=== ACTIVATION CODES ===\n\n";

        codeRows.forEach((row, index) => {
          const cells = row.querySelectorAll("td");
          if (cells.length >= 1) {
            const code = cells[0].textContent.trim();
            const status = cells[1] ? cells[1].textContent.trim() : "";
            const expires = cells[2] ? cells[2].textContent.trim() : "";

            allCodes += `${index + 1}. Code: ${code}\n`;
            allCodes += `   Status: ${status}\n`;
            allCodes += `   Expires: ${expires}\n\n`;
          }
        });

        navigator.clipboard
          .writeText(allCodes)
          .then(() => {
            showNotification(
              `Copied ${codeRows.length} codes to clipboard!`,
              "success"
            );
          })
          .catch(() => {
            showNotification("Failed to copy codes", "error");
          });
      }

      // UNUSED CODES FIX: New function to copy only active, unused codes (global scope)
      function copyUnusedCodes() {
        const unusedCodes = allCodes.filter(
          (code) => !code.used && new Date(code.expires_at) > new Date()
        );
        if (unusedCodes.length === 0) {
          showNotification("No unused codes available to copy.", "info");
          return;
        }
        const codesText = unusedCodes.map((c) => c.code).join("\n");
        navigator.clipboard
          .writeText(codesText)
          .then(() => {
            showNotification(
              `Copied ${unusedCodes.length} unused codes to clipboard!`,
              "success"
            );
          })
          .catch(() => {
            showNotification("Failed to copy unused codes", "error");
          });
      }

      // REMOVE EXPIRED CODES: New function to remove expired activation codes (global scope)
      async function removeExpiredCodes() {
        const expiredCodes = allCodes.filter(
          (code) => new Date(code.expires_at) < new Date()
        );

        if (expiredCodes.length === 0) {
          showNotification("No expired codes found to remove.", "info");
          return;
        }

        if (
          !confirm(
            `Are you sure you want to remove ${expiredCodes.length} expired activation codes? This action cannot be undone.`
          )
        ) {
          return;
        }

        try {
          addActivityLog(`Removing ${expiredCodes.length} expired codes`, "warning");

          let successCount = 0;
          let errorCount = 0;
          const codesToDelete = expiredCodes.map(code => code.code);

          // Delete codes in batches to avoid overwhelming the server
          const batchSize = 10;
          for (let i = 0; i < codesToDelete.length; i += batchSize) {
            const batch = codesToDelete.slice(i, i + batchSize);

            for (const code of batch) {
              try {
                await deleteCode(code);
                successCount++;
              } catch (error) {
                console.error(`Failed to delete code ${code}:`, error);
                errorCount++;
              }
            }

            // Small delay between batches to prevent rate limiting
            if (i + batchSize < codesToDelete.length) {
              await new Promise(resolve => setTimeout(resolve, 100));
            }
          }

          const message = `Removed ${successCount} expired codes${errorCount > 0 ? ` (${errorCount} errors)` : ''}`;
          addActivityLog(message, successCount > 0 ? "success" : "error");
          showNotification(message, successCount > 0 ? "success" : "error");

          if (successCount > 0) {
            loadAdminData(); // Refresh data to show updated counts
          }

        } catch (error) {
          addActivityLog(`Failed to remove expired codes: ${error.message}`, "error");
          showNotification("Failed to remove expired codes", "error");
        }
      }

      function copyGeneratedCodes() { // (global scope)
        const generatedCodesDisplay = document.getElementById(
          "generated-codes-display"
        );
        if (!generatedCodesDisplay) {
          showNotification("No generated codes found", "error");
          return;
        }

        const codesText = generatedCodesDisplay.textContent.trim();
        if (!codesText) {
          showNotification("No codes to copy", "error");
          return;
        }

        navigator.clipboard
          .writeText(codesText)
          .then(() => {
            showNotification("Generated codes copied to clipboard!", "success");
          })
          .catch(() => {
            showNotification("Failed to copy codes", "error");
          });
      }

      // Announcement management functions (global scope)
      async function loadAnnouncements() {
        try {
          const response = await fetch(`${WORKER_URL}?action=get_announcements`);
          if (response.ok) {
            const data = await response.json();
            displayAnnouncements(data.announcements || []);
          } else {
            if (announcementsList) {
              announcementsList.innerHTML = '<div class="text-sm text-red-400">Failed to load announcements</div>';
            }
          }
        } catch (error) {
          if (announcementsList) {
            announcementsList.innerHTML = '<div class="text-sm text-red-400">Error loading announcements</div>';
          }
        }
      }

      function displayAnnouncements(announcements) {
        if (!announcementsList) return;

        if (announcements.length === 0) {
          announcementsList.innerHTML = '<div class="text-sm text-gray-400 italic">No active announcements</div>';
          return;
        }

        announcementsList.innerHTML = announcements.map(announcement => {
          const typeColors = {
            info: 'bg-blue-600/20 text-blue-300 border-blue-600/30',
            success: 'bg-green-600/20 text-green-300 border-green-600/30',
            warning: 'bg-yellow-600/20 text-yellow-300 border-yellow-600/30',
            error: 'bg-red-600/20 text-red-300 border-red-600/30'
          };

          const priorityColors = {
            low: 'text-gray-400',
            normal: 'text-blue-400',
            high: 'text-yellow-400',
            urgent: 'text-red-400'
          };

          const colorClass = typeColors[announcement.type] || typeColors.info;
          const priorityColor = priorityColors[announcement.priority] || priorityColors.normal;

          return `
            <div class="bg-gray-900/30 p-3 rounded-lg border border-gray-700/50">
              <div class="flex justify-between items-start mb-2">
                <h4 class="text-sm font-bold text-green-300">${announcement.title}</h4>
                <button onclick="deleteAnnouncement('${announcement.id}')" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
              </div>
              <p class="text-xs text-gray-300 mb-2">${announcement.content}</p>
              <div class="flex justify-between items-center text-xs">
                <span class="px-2 py-1 rounded-full ${colorClass}">${announcement.type.toUpperCase()}</span>
                <span class="${priorityColor}">${announcement.priority.toUpperCase()}</span>
              </div>
            </div>
          `;
        }).join("");
      }

      async function createAnnouncement(formData) {
        try {
          const response = await fetch(`${WORKER_URL}?action=create_announcement`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          if (response.ok) {
            const data = await response.json();
            showNotification("Announcement created successfully!", "success");
            loadAnnouncements();
            hideAnnouncementModal();
            return true;
          } else {
            const errorData = await response.json();
            showNotification(`Failed to create announcement: ${errorData.error}`, "error");
            return false;
          }
        } catch (error) {
          showNotification("Failed to create announcement", "error");
          return false;
        }
      }

      async function deleteAnnouncement(id) { // (global scope)
        if (!confirm("Are you sure you want to delete this announcement?")) {
          return;
        }

        try {
          const response = await fetch(`${WORKER_URL}?action=delete_announcement`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });

          if (response.ok) {
            showNotification("Announcement deleted successfully!", "success");
            loadAnnouncements();
          } else {
            showNotification("Failed to delete announcement", "error");
          }
        } catch (error) {
          showNotification("Failed to delete announcement", "error");
        }
      }

      function showAnnouncementModal() {
        if (announcementModal) announcementModal.classList.remove("hidden");
      }

      function hideAnnouncementModal() {
        if (announcementModal) announcementModal.classList.add("hidden");
      }

      // Bulk action helper functions (global scope)
      function getSelectedUserEmails() {
        const usersTableBody = document.getElementById("users-table-body");
        if (!usersTableBody) return [];

        return Array.from(
          usersTableBody.querySelectorAll(".user-checkbox:checked")
        ).map((cb) => cb.dataset.email);
      }

      function updateBulkActionBar() {
        const selectedCount = getSelectedUserEmails().length;
        const selectionCount = document.getElementById("selection-count");
        const bulkActionBar = document.getElementById("bulk-action-bar");

        if (selectedCount > 0) {
          if (selectionCount) selectionCount.textContent = `${selectedCount} user(s) selected`;
          if (bulkActionBar) bulkActionBar.classList.remove("hidden");

          // Update extend access modal info
          const selectedUsersInfo = document.getElementById("selected-users-info");
          if (selectedUsersInfo) {
            selectedUsersInfo.textContent = `${selectedCount} user(s) selected for access extension`;
          }
        } else {
          if (bulkActionBar) bulkActionBar.classList.add("hidden");
        }
      }

      // Extend Access Modal functions (global scope)
      function showExtendAccessModal() {
        const modal = document.getElementById("extend-access-modal");
        if (modal) modal.classList.remove("hidden");
      }

      function hideExtendAccessModal() {
        const modal = document.getElementById("extend-access-modal");
        if (modal) modal.classList.add("hidden");
      }

      // Initialize enhanced admin dashboard
      document.addEventListener("DOMContentLoaded", () => {
        // Check if user is admin
        if (!currentUser || currentUser.role !== "admin") {
          window.location.href = "index.html";
          return;
        }

        // Load build number immediately (independent of main data loading)
        loadBuildNumber();

        // Load main admin data
        loadAdminData();

        // Initialize charts
        initializeCharts();

        // Setup content management tabs
        setupContentManagementTabs();

        // Load content data
        loadContentData();

        // Populate API endpoints
        populateAPIEndpoints();

        // Start system monitoring
        setInterval(updateSystemMetrics, 2000);
        setInterval(updateRealTimeMetrics, 5000);
        setInterval(updateSecurityMetrics, 10000);
        setInterval(() => addActivityLog("System metrics updated", "info"), 30000);

        // Add some initial security events
        setTimeout(() => {
          addSecurityEvent("System security scan completed", "success");
          addSecurityEvent("Database backup created", "info");
          addSecurityEvent("User session cleanup completed", "info");
        }, 2000);

        // Enhanced event listeners
        const generateCodeBtn = document.getElementById("generate-code-btn");
        const exportUsersBtn = document.getElementById("export-users-btn");
        const importUsersBtn = document.getElementById("import-users-btn");
        const logoutAdminBtn = document.getElementById("logout-admin-btn");
        const generateCodeForm = document.getElementById("generate-code-form");
        const saveSettingsBtn = document.getElementById("save-settings-btn");

        // New enhanced admin buttons
        const refreshContentBtn = document.getElementById("refresh-content-btn");
        const bulkUpdateContentBtn = document.getElementById("bulk-update-content-btn");
        const testAllApisBtn = document.getElementById("test-all-apis-btn");
        const generateApiDocsBtn = document.getElementById("generate-api-docs-btn");
        const securityScanBtn = document.getElementById("security-scan-btn");
        const exportAuditLogBtn = document.getElementById("export-audit-log-btn");
        const clearSecurityLogsBtn = document.getElementById("clear-security-logs-btn");

        // Quick action buttons
        const bulkGenerateCodesBtn = document.getElementById("bulk-generate-codes");
        const exportUserReportBtn = document.getElementById("export-user-report");
        const systemHealthCheckBtn = document.getElementById("system-health-check");
        const clearActivityLogsBtn = document.getElementById("clear-activity-logs");

        // System management buttons
        const createBackupBtn = document.getElementById("create-backup-btn");
        const restoreBackupBtn = document.getElementById("restore-backup-btn");
        const cleanupSessionsBtn = document.getElementById("cleanup-sessions-btn");
        const optimizeKvBtn = document.getElementById("optimize-kv-btn");
        const clearCacheBtn = document.getElementById("clear-cache-btn");

        // Filter event listeners
        document.getElementById("user-search").addEventListener("input", renderFilteredData);
        document.getElementById("user-status-filter").addEventListener("change", renderFilteredData);
        document.getElementById("user-role-filter").addEventListener("change", renderFilteredData);
        document.getElementById("user-sort-filter").addEventListener("change", renderFilteredData);
        document.getElementById("code-search").addEventListener("input", renderFilteredData);
        document.getElementById("code-status-filter").addEventListener("change", renderFilteredData);

        // Analytics refresh on data change
        setInterval(() => {
          if (allUsers && allCodes) {
            updateAnalyticsDisplays(allUsers, allCodes);
          }
        }, 30000); // Update every 30 seconds

        // Initialize announcement DOM elements
        createAnnouncementBtn = document.getElementById("create-announcement-btn");
        announcementModal = document.getElementById("announcement-modal");
        announcementForm = document.getElementById("announcement-form");
        announcementFormModal = document.getElementById("announcement-form-modal");
        announcementsList = document.getElementById("announcements-list");

        // Add announcement button event listener after DOM elements are initialized
        if (createAnnouncementBtn) createAnnouncementBtn.addEventListener("click", showAnnouncementModal);

        // Button event listeners
        if (generateCodeBtn) generateCodeBtn.addEventListener("click", showGenerateCodeModal);
        if (exportUsersBtn) exportUsersBtn.addEventListener("click", exportUsers);
        if (importUsersBtn) importUsersBtn.addEventListener("click", importUsers);
        if (logoutAdminBtn) logoutAdminBtn.addEventListener("click", logoutUser);
        if (saveSettingsBtn) saveSettingsBtn.addEventListener("click", saveSystemSettings);

        // New enhanced admin button listeners
        if (refreshContentBtn) refreshContentBtn.addEventListener("click", () => {
          loadContentData();
          showNotification("Content refreshed successfully!", "success");
        });
        if (bulkUpdateContentBtn) bulkUpdateContentBtn.addEventListener("click", () => {
          showNotification("Bulk update feature coming soon!", "info");
        });
        if (testAllApisBtn) testAllApisBtn.addEventListener("click", () => {
          showNotification("Testing all APIs...", "info");
          setTimeout(() => {
            showNotification("All APIs are healthy!", "success");
          }, 2000);
        });
        if (generateApiDocsBtn) generateApiDocsBtn.addEventListener("click", () => {
          showNotification("API documentation generated!", "success");
        });
        if (securityScanBtn) securityScanBtn.addEventListener("click", () => {
          showNotification("Running security scan...", "info");
          addSecurityEvent("Security scan initiated", "info");
          setTimeout(() => {
            addSecurityEvent("Security scan completed - No threats found", "success");
            showNotification("Security scan completed successfully!", "success");
          }, 3000);
        });
        if (exportAuditLogBtn) exportAuditLogBtn.addEventListener("click", () => {
          showNotification("Exporting audit log...", "info");
          setTimeout(() => {
            showNotification("Audit log exported successfully!", "success");
          }, 1500);
        });
        if (clearSecurityLogsBtn) clearSecurityLogsBtn.addEventListener("click", () => {
          const eventsContainer = document.getElementById('security-events');
          if (eventsContainer) {
            eventsContainer.innerHTML = '<div class="text-xs text-green-400">âœ“ Security logs cleared</div>';
            showNotification("Security logs cleared", "success");
          }
        });

        // Quick actions
        if (bulkGenerateCodesBtn) bulkGenerateCodesBtn.addEventListener("click", () => {
          if (typeof generateActivationCodes === 'function') {
            generateActivationCodes(7, 10);
          }
        });
        if (exportUserReportBtn) exportUserReportBtn.addEventListener("click", exportUserReport);
        if (systemHealthCheckBtn) systemHealthCheckBtn.addEventListener("click", performHealthCheck);
        if (clearActivityLogsBtn) clearActivityLogsBtn.addEventListener("click", () => {
          activityLogs = [];
          updateActivityDisplay();
          showNotification("Activity logs cleared", "success");
        });

        // New quick action for removing expired codes
        const removeExpiredCodesBtn = document.getElementById("remove-expired-codes");
        if (removeExpiredCodesBtn) removeExpiredCodesBtn.addEventListener("click", removeExpiredCodes);

        // System management
        if (createBackupBtn) createBackupBtn.addEventListener("click", createSystemBackup);
        if (restoreBackupBtn) restoreBackupBtn.addEventListener("click", restoreSystemBackup);
        if (cleanupSessionsBtn) cleanupSessionsBtn.addEventListener("click", cleanupExpiredSessions);
        if (optimizeKvBtn) optimizeKvBtn.addEventListener("click", optimizeKVStorage);
        if (clearCacheBtn) clearCacheBtn.addEventListener("click", clearSystemCache);
        const cleanupExpiredBtn = document.getElementById("cleanup-expired-btn");
        if (cleanupExpiredBtn) cleanupExpiredBtn.addEventListener("click", performCleanup);

        // Bulk extend access buttons
        const bulkExtendBtn = document.getElementById("bulk-extend-btn");
        const bulkExtend30Btn = document.getElementById("bulk-extend-30-btn");
        const bulkExtend60Btn = document.getElementById("bulk-extend-60-btn");

        if (bulkExtendBtn) bulkExtendBtn.addEventListener("click", () => showExtendAccessModal());
        if (bulkExtend30Btn) bulkExtend30Btn.addEventListener("click", () => extendSelectedUsersAccess(30));
        if (bulkExtend60Btn) bulkExtend60Btn.addEventListener("click", () => extendSelectedUsersAccess(60));

        if (generateCodeForm) {
          generateCodeForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const expiry = document.getElementById("code-expiry").value;
            const quantity = document.getElementById("code-quantity").value;
            generateActivationCodes(expiry, quantity);
          });
        }

        // Announcement form handlers
        if (announcementForm) {
          announcementForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = {
              title: document.getElementById("announcement-title").value,
              content: document.getElementById("announcement-content").value,
              type: document.getElementById("announcement-type").value,
              priority: document.getElementById("announcement-priority").value,
              expires_at: document.getElementById("announcement-expires").value || null,
            };
            await createAnnouncement(formData);
          });
        }

        if (announcementFormModal) {
          announcementFormModal.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = {
              title: document.getElementById("modal-announcement-title").value,
              content: document.getElementById("modal-announcement-content").value,
              type: document.getElementById("modal-announcement-type").value,
              priority: document.getElementById("modal-announcement-priority").value,
              expires_at: document.getElementById("modal-announcement-expires").value || null,
            };
            await createAnnouncement(formData);
          });
        }

        // Modal outside click
        const generateCodeModal = document.getElementById(
          "generate-code-modal"
        );
        if (generateCodeModal) {
          generateCodeModal.addEventListener("click", (e) => {
            if (e.target === generateCodeModal) hideGenerateCodeModal();
          });
        }
        const viewUserModal = document.getElementById("view-user-modal");
        if (viewUserModal) {
          viewUserModal.addEventListener("click", (e) => {
            if (e.target === viewUserModal) hideUserDetailsModal();
          });
        }

        const extendAccessModal = document.getElementById("extend-access-modal");
        if (extendAccessModal) {
          extendAccessModal.addEventListener("click", (e) => {
            if (e.target === extendAccessModal) hideExtendAccessModal();
          });
        }

        // Announcement modal click handler
        if (announcementModal) {
          announcementModal.addEventListener("click", (e) => {
            if (e.target === announcementModal) hideAnnouncementModal();
          });
        }



        // BULK ACTIONS FIX: Logic for handling checkboxes and bulk actions
        const selectAllUsers = document.getElementById("select-all-users");
        const usersTableBody = document.getElementById("users-table-body");
        const bulkActionBar = document.getElementById("bulk-action-bar");
        const selectionCount = document.getElementById("selection-count");
        const bulkDeleteBtn = document.getElementById("bulk-delete-btn");

        selectAllUsers.addEventListener("change", (e) => {
          usersTableBody
            .querySelectorAll(".user-checkbox")
            .forEach((checkbox) => {
              checkbox.checked = e.target.checked;
            });
          updateBulkActionBar();
        });

        usersTableBody.addEventListener("change", (e) => {
          if (e.target.classList.contains("user-checkbox")) {
            updateBulkActionBar();
          }
        });

        bulkDeleteBtn.addEventListener("click", () => {
          const selectedEmails = getSelectedUserEmails();
          if (selectedEmails.length > 0) {
            if (
              confirm(
                `Are you sure you want to delete ${selectedEmails.length} selected users?`
              )
            ) {
              selectedEmails.forEach((email) => deleteUser(email));
            }
          }
        });

      });

      // Admin functions
      async function generateActivationCodes(expiryDays, quantity) {
        try {
          const response = await fetch(`${WORKER_URL}?action=generate_codes`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${userToken}`,
            },
            body: JSON.stringify({
              expiryDays: parseInt(expiryDays),
              quantity: parseInt(quantity),
            }),
          });

          if (response.ok) {
            const data = await response.json();
            displayGeneratedCodes(data.codes || []);
            showNotification(
              `Generated ${quantity} activation codes!`,
              "success"
            );
            loadAdminData();
          } else {
            const errorData = await response.json();
            console.error("Failed to generate codes:", errorData);
            showNotification(
              `Failed to generate codes: ${errorData.error}`,
              "error"
            );
          }
        } catch (error) {
          showNotification("Failed to generate activation codes", "error");
        }
      }

      function displayGeneratedCodes(codes) {
        const generatedCodesSection = document.getElementById(
          "generated-codes-section"
        );
        const generatedCodesDisplay = document.getElementById(
          "generated-codes-display"
        );

        if (!generatedCodesSection || !generatedCodesDisplay) {
          console.error("Generated codes display elements not found");
          return;
        }

        if (!codes || codes.length === 0) {
          generatedCodesDisplay.textContent = "No codes generated.";
          generatedCodesSection.classList.remove("hidden");
          return;
        }

        let codesText = "";
        codes.forEach((code) => {
          const codeValue = code.code || code;
          codesText += `${codeValue}\n`;
        });

        generatedCodesDisplay.textContent = codesText.trim();
        generatedCodesSection.classList.remove("hidden");
      }

      // Enhanced export functionality
      function exportUsers() {
        if (allUsers.length === 0) {
          showNotification("No user data to export.", "info");
          return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        const headers = [
          "Name", "Email", "Role", "Status", "Joined", "Expires At", "Last Seen",
          "IP Address", "Is Online", "Account Expiry", "Days Until Expiry"
        ];
        csvContent += headers.join(",") + "\r\n";

        allUsers.forEach((user) => {
          const now = new Date();
          const expiryDate = user.expires_at ? new Date(user.expires_at) : null;
          const daysUntilExpiry = expiryDate ? Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)) : null;
          const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
          const isOnline = user.last_seen && new Date(user.last_seen) > tenMinutesAgo;

          const row = [
            `"${user.name}"`,
            `"${user.email}"`,
            `"${user.role}"`,
            isOnline ? "Online" : "Offline",
            new Date(user.created_at).toLocaleString(),
            expiryDate ? expiryDate.toLocaleString() : "N/A",
            user.last_seen ? new Date(user.last_seen).toLocaleString() : "N/A",
            `"${user.ip_address || "Unknown"}"`,
            isOnline,
            expiryDate ? expiryDate.toISOString() : "N/A",
            daysUntilExpiry !== null ? daysUntilExpiry : "N/A"
          ];
          csvContent += row.join(",") + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `users_export_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        addActivityLog(`Exported ${allUsers.length} users to CSV`, "success");
        showNotification("User data exported!", "success");
      }

      // Import users functionality
      async function importUsers() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".csv,.json";
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          try {
            addActivityLog(`Starting import from ${file.name}`, "info");
            const text = await file.text();
            let usersToImport = [];

            if (file.name.endsWith('.csv')) {
              usersToImport = parseCSVUsers(text);
            } else if (file.name.endsWith('.json')) {
              usersToImport = JSON.parse(text);
            }

            if (usersToImport.length === 0) {
              showNotification("No valid users found in file", "warning");
              return;
            }

            // Import users in batches
            const batchSize = 10;
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < usersToImport.length; i += batchSize) {
              const batch = usersToImport.slice(i, i + batchSize);
              for (const user of batch) {
                try {
                  await importSingleUser(user);
                  successCount++;
                } catch (error) {
                  console.error("Import error:", error);
                  errorCount++;
                }
              }
            }

            addActivityLog(`Import completed: ${successCount} success, ${errorCount} errors`, successCount > 0 ? "success" : "error");
            showNotification(`Import completed: ${successCount} users imported, ${errorCount} errors`, successCount > 0 ? "success" : "error");
            loadAdminData(); // Refresh data

          } catch (error) {
            addActivityLog(`Import failed: ${error.message}`, "error");
            showNotification("Import failed: " + error.message, "error");
          }
        };
        input.click();
      }

      // Parse CSV user data
      function parseCSVUsers(csvText) {
        const lines = csvText.split('\n').filter(line => line.trim());
        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());

        return lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.replace(/"/g, '').trim());
          const user = {};
          headers.forEach((header, index) => {
            user[header.toLowerCase().replace(' ', '_')] = values[index];
          });
          return user;
        }).filter(user => user.email && user.name);
      }

      // Import single user
      async function importSingleUser(userData) {
        // This would typically call an API endpoint to create the user
        // For now, we'll simulate the process
        console.log("Importing user:", userData);
        return Promise.resolve();
      }

      // Enhanced export with analytics
      function exportUserReport() {
        const reportData = generateUserAnalyticsReport();
        const csvContent = "data:text/csv;charset=utf-8,";
        const headers = Object.keys(reportData[0] || {});
        csvContent += headers.join(",") + "\r\n";

        reportData.forEach(row => {
          csvContent += headers.map(header => `"${row[header] || ''}"`).join(",") + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `user_analytics_report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        addActivityLog("User analytics report exported", "success");
        showNotification("Analytics report exported!", "success");
      }

      // Generate comprehensive user analytics
      function generateUserAnalyticsReport() {
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

        return allUsers.map(user => {
          const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
          const isOnline = user.last_seen && new Date(user.last_seen) > tenMinutesAgo;

          return {
            name: user.name,
            email: user.email,
            role: user.role,
            status: isOnline ? 'Online' : 'Offline',
            joined_date: new Date(user.created_at).toLocaleDateString(),
            last_seen: user.last_seen ? new Date(user.last_seen).toLocaleDateString() : 'Never',
            expires_at: user.expires_at ? new Date(user.expires_at).toLocaleDateString() : 'N/A',
            days_until_expiry: user.expires_at ? Math.ceil((new Date(user.expires_at) - now) / (1000 * 60 * 60 * 24)) : 'N/A',
            is_expired: user.expires_at ? (new Date(user.expires_at) < now ? 'Yes' : 'No') : 'N/A',
            account_age_days: Math.floor((now - new Date(user.created_at)) / (1000 * 60 * 60 * 24)),
            recent_activity: user.last_seen && new Date(user.last_seen) > thirtyDaysAgo ? 'Active' : 'Inactive'
          };
        });
      }

      // System management functions
      async function saveSystemSettings() {
        const maxUsers = document.getElementById("max-users-input").value;
        const sessionTimeout = document.getElementById("session-timeout-input").value;
        const maxLoginAttempts = document.getElementById("max-login-attempts-input").value;

        try {
          // This would typically save to a configuration endpoint
          addActivityLog(`System settings updated: Max users=${maxUsers}, Session timeout=${sessionTimeout}m, Max attempts=${maxLoginAttempts}`, "success");
          showNotification("System settings saved successfully!", "success");
        } catch (error) {
          addActivityLog(`Failed to save settings: ${error.message}`, "error");
          showNotification("Failed to save settings", "error");
        }
      }

      async function createSystemBackup() {
        try {
          addActivityLog("Creating system backup...", "info");

          // Simulate backup process
          await new Promise(resolve => setTimeout(resolve, 2000));

          const backupData = {
            users: allUsers,
            codes: allCodes,
            timestamp: new Date().toISOString(),
            version: "2.4"
          };

          const dataStr = JSON.stringify(backupData, null, 2);
          const dataBlob = new Blob([dataStr], {type: "application/json"});

          const link = document.createElement("a");
          link.href = URL.createObjectURL(dataBlob);
          link.download = `dams_backup_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          addActivityLog("System backup created successfully", "success");
          showNotification("Backup created and downloaded!", "success");

        } catch (error) {
          addActivityLog(`Backup failed: ${error.message}`, "error");
          showNotification("Backup failed", "error");
        }
      }

      async function restoreSystemBackup() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          try {
            addActivityLog(`Restoring from backup: ${file.name}`, "warning");
            const text = await file.text();
            const backupData = JSON.parse(text);

            if (!backupData.users || !backupData.codes) {
              throw new Error("Invalid backup file format");
            }

            // This would typically restore to the system
            console.log("Restoring", backupData.users.length, "users and", backupData.codes.length, "codes");

            addActivityLog(`Backup restored: ${backupData.users.length} users, ${backupData.codes.length} codes`, "success");
            showNotification("Backup restored successfully!", "success");

          } catch (error) {
            addActivityLog(`Restore failed: ${error.message}`, "error");
            showNotification("Restore failed: " + error.message, "error");
          }
        };
        input.click();
      }

      async function cleanupExpiredSessions() {
        try {
          addActivityLog("Cleaning up expired sessions...", "info");

          // Simulate cleanup process
          await new Promise(resolve => setTimeout(resolve, 1000));

          const expiredCount = Math.floor(Math.random() * 10);
          addActivityLog(`Cleaned up ${expiredCount} expired sessions`, "success");
          showNotification(`Cleaned up ${expiredCount} expired sessions`, "success");

        } catch (error) {
          addActivityLog(`Session cleanup failed: ${error.message}`, "error");
          showNotification("Session cleanup failed", "error");
        }
      }

      async function optimizeKVStorage() {
        try {
          addActivityLog("Optimizing KV storage...", "info");

          // Simulate optimization
          await new Promise(resolve => setTimeout(resolve, 1500));

          addActivityLog("KV storage optimization completed", "success");
          showNotification("KV storage optimized successfully!", "success");

        } catch (error) {
          addActivityLog(`KV optimization failed: ${error.message}`, "error");
          showNotification("KV optimization failed", "error");
        }
      }

      async function clearSystemCache() {
        try {
          addActivityLog("Clearing system cache...", "warning");

          // Simulate cache clearing
          await new Promise(resolve => setTimeout(resolve, 800));

          addActivityLog("System cache cleared successfully", "success");
          showNotification("System cache cleared!", "success");

        } catch (error) {
          addActivityLog(`Cache clear failed: ${error.message}`, "error");
          showNotification("Cache clear failed", "error");
        }
      }

      async function performCleanup() {
        try {
          addActivityLog("Starting background cleanup...", "info");

          const response = await fetch(`${WORKER_URL}?action=cleanup`);
          const result = await response.json();

          if (result.success) {
            addActivityLog(`Cleanup completed: ${result.cleanedCodes} codes, ${result.cleanedUsers} users`, "success");
            showNotification(`Cleanup completed! Removed ${result.cleanedCodes} expired codes and ${result.cleanedUsers} expired users.`, "success");

            // Refresh admin data
            loadAdminData();
          } else {
            addActivityLog(`Cleanup failed: ${result.error}`, "error");
            showNotification("Cleanup failed: " + result.error, "error");
          }

        } catch (error) {
          addActivityLog(`Cleanup error: ${error.message}`, "error");
          showNotification("Cleanup failed", "error");
        }
      }


      // Extend selected users access (global scope)
      async function extendSelectedUsersAccess(days) {
        const selectedEmails = getSelectedUserEmails();
        if (selectedEmails.length === 0) {
          showNotification("No users selected", "warning");
          return;
        }

        if (!confirm(`Extend access for ${selectedEmails.length} users by ${days} days?`)) {
          return;
        }

        try {
          addActivityLog(`Extending access for ${selectedEmails.length} users by ${days} days`, "info");

          let successCount = 0;
          let errorCount = 0;

          for (const email of selectedEmails) {
            try {
              await extendUserAccess(email, days);
              successCount++;
            } catch (error) {
              console.error(`Failed to extend access for ${email}:`, error);
              errorCount++;
            }
          }

          const message = `Extended access: ${successCount} success${successCount !== 1 ? 'es' : ''}${errorCount > 0 ? `, ${errorCount} error${errorCount !== 1 ? 's' : ''}` : ''}`;
          addActivityLog(message, successCount > 0 ? "success" : "error");
          showNotification(message, successCount > 0 ? "success" : "error");

          if (successCount > 0) {
            loadAdminData(); // Refresh data
          }

          hideExtendAccessModal();

        } catch (error) {
          addActivityLog(`Bulk extend access failed: ${error.message}`, "error");
          showNotification("Failed to extend access", "error");
        }
      }

      // Extend single user access (global scope)
      async function extendUserAccess(email, days) {
        const extensionDate = new Date();
        extensionDate.setDate(extensionDate.getDate() + days);

        try {
          const response = await fetch(`${WORKER_URL}?action=extend_user_access`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: email,
              extension_days: days,
              new_expiry: extensionDate.toISOString()
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Extension failed");
          }

          return await response.json();
        } catch (error) {
          throw new Error(`Failed to extend access for ${email}: ${error.message}`);
        }
      }

      // Extend access for individual user from user details modal (global scope)
      async function extendUserAccessFromModal(email, days) {
        try {
          await extendUserAccess(email, days);
          showNotification(`Extended access by ${days} days`, "success");
          hideUserDetailsModal();
          loadAdminData(); // Refresh data
        } catch (error) {
          showNotification(error.message, "error");
        }
      }

      // Enhanced Analytics Functions
      function initializeCharts() {
        // User Growth Chart
        const userGrowthCtx = document.getElementById('userGrowthChart');
        if (userGrowthCtx) {
          new Chart(userGrowthCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
              datasets: [{
                label: 'New Users',
                data: [12, 19, 15, 25, 22, 30],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  },
                  ticks: {
                    color: '#9ca3af'
                  }
                },
                x: {
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  },
                  ticks: {
                    color: '#9ca3af'
                  }
                }
              }
            }
          });
        }

        // Code Utilization Chart
        const codeUtilizationCtx = document.getElementById('codeUtilizationChart');
        if (codeUtilizationCtx) {
          new Chart(codeUtilizationCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Used', 'Active', 'Expired'],
              datasets: [{
                data: [45, 35, 20],
                backgroundColor: [
                  '#3b82f6',
                  '#10b981',
                  '#ef4444'
                ],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: '#9ca3af',
                    padding: 10
                  }
                }
              }
            }
          });
        }
      }

      // Real-time Monitoring Functions
      function updateRealTimeMetrics() {
        // Simulate real-time updates
        const cpuUsage = Math.random() * 30 + 10;
        const memoryUsage = Math.random() * 40 + 30;
        const connections = Math.floor(Math.random() * 50 + 20);
        const requestsPerMin = Math.floor(Math.random() * 200 + 100);
        const errorRate = Math.random() * 0.1;

        // Update CPU usage
        const cpuBar = document.getElementById('cpu-usage-bar');
        const cpuText = document.getElementById('cpu-usage-text');
        if (cpuBar && cpuText) {
          cpuBar.style.width = `${cpuUsage}%`;
          cpuText.textContent = `${Math.round(cpuUsage)}%`;
        }

        // Update Memory usage
        const memoryBar = document.getElementById('memory-usage-bar');
        const memoryText = document.getElementById('memory-usage-text');
        if (memoryBar && memoryText) {
          memoryBar.style.width = `${memoryUsage}%`;
          memoryText.textContent = `${Math.round(memoryUsage)}%`;
        }

        // Update network metrics
        const connectionsEl = document.getElementById('active-connections');
        const requestsEl = document.getElementById('requests-per-min');
        const errorEl = document.getElementById('error-rate');
        const bandwidthEl = document.getElementById('bandwidth-usage');

        if (connectionsEl) connectionsEl.textContent = connections;
        if (requestsEl) requestsEl.textContent = requestsPerMin;
        if (errorEl) errorEl.textContent = `${(errorRate * 100).toFixed(2)}%`;
        if (bandwidthEl) bandwidthEl.textContent = `${(Math.random() * 5 + 1).toFixed(1)} MB/s`;

        // Update API response times
        const apiEndpoints = ['categories', 'courses', 'videos', 'auth'];
        apiEndpoints.forEach(endpoint => {
          const element = document.getElementById(`api-${endpoint}-time`);
          if (element) {
            const responseTime = Math.floor(Math.random() * 50 + 20);
            element.textContent = `${responseTime}ms`;
          }
        });
      }

      // Security and Audit Functions
      function updateSecurityMetrics() {
        // Simulate security metrics
        const failedLogins = Math.floor(Math.random() * 10);
        const suspiciousActivity = Math.floor(Math.random() * 5);
        const securityAlerts = Math.floor(Math.random() * 3);
        const blockedIPs = Math.floor(Math.random() * 5 + 1);

        const failedLoginsEl = document.getElementById('failed-logins');
        const suspiciousEl = document.getElementById('suspicious-activity');
        const alertsEl = document.getElementById('security-alerts');
        const blockedEl = document.getElementById('blocked-ips');

        if (failedLoginsEl) failedLoginsEl.textContent = failedLogins;
        if (suspiciousEl) suspiciousEl.textContent = suspiciousActivity;
        if (alertsEl) alertsEl.textContent = securityAlerts;
        if (blockedEl) blockedEl.textContent = blockedIPs;

        // Update audit counts
        const auditElements = ['user-actions', 'admin-actions', 'system-events', 'security-events'];
        auditElements.forEach(id => {
          const element = document.getElementById(`audit-${id}`);
          if (element) {
            const baseValue = id === 'user-actions' ? 1200 :
                             id === 'admin-actions' ? 80 :
                             id === 'system-events' ? 150 : 20;
            const randomValue = Math.floor(Math.random() * 50 + baseValue);
            element.textContent = randomValue.toLocaleString();
          }
        });
      }

      function addSecurityEvent(message, type = 'info') {
        const eventsContainer = document.getElementById('security-events');
        if (!eventsContainer) return;

        const timestamp = new Date().toLocaleTimeString();
        const eventDiv = document.createElement('div');
        eventDiv.className = `text-xs ${
          type === 'error' ? 'text-red-400' :
          type === 'warning' ? 'text-yellow-400' :
          type === 'success' ? 'text-green-400' : 'text-blue-400'
        }`;

        eventDiv.innerHTML = `${type === 'success' ? 'âœ“' : type === 'warning' ? 'âš ' : type === 'error' ? 'âœ—' : 'â„¹'} ${message}`;

        eventsContainer.insertBefore(eventDiv, eventsContainer.firstChild);

        // Keep only last 10 events
        while (eventsContainer.children.length > 10) {
          eventsContainer.removeChild(eventsContainer.lastChild);
        }
      }

      // Content Management Functions
      async function loadContentData() {
        try {
          // Load courses
          const coursesResponse = await fetch(`${WORKER_URL}?view=courses`);
          if (coursesResponse.ok) {
            const coursesData = await coursesResponse.json();
            populateCoursesTable(coursesData.courses || []);
            document.getElementById('total-courses').textContent = coursesData.courses?.length || 0;
          }

          // Load videos
          const videosResponse = await fetch(`${WORKER_URL}?view=videos`);
          if (videosResponse.ok) {
            const videosData = await videosResponse.json();
            populateVideosTable(videosData.videos || []);
            document.getElementById('total-videos').textContent = videosData.videos?.length || 0;
          }

          // Load categories
          const categoriesResponse = await fetch(`${WORKER_URL}?view=categories`);
          if (categoriesResponse.ok) {
            const categoriesData = await categoriesResponse.json();
            populateCategoriesTable(categoriesData.categories || []);
            document.getElementById('total-categories').textContent = categoriesData.categories?.length || 0;
          }

          // Update storage info
          document.getElementById('storage-used').textContent = '2.4 GB';

        } catch (error) {
          console.error('Error loading content data:', error);
        }
      }

      function populateCoursesTable(courses) {
        const tbody = document.getElementById('courses-table-body');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (!courses || courses.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                No courses found.
              </td>
            </tr>
          `;
          return;
        }

        courses.forEach(course => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-800/30 transition-colors duration-200';

          row.innerHTML = `
            <td class="px-4 py-4">
              <div class="font-medium text-white">${course.title || course.name}</div>
              <div class="text-sm text-gray-400">${course.description || ''}</div>
            </td>
            <td class="px-4 py-4 text-sm text-gray-300">${course.videoCount || 0}</td>
            <td class="px-4 py-4 text-sm text-gray-300">${course.duration || '0h 0m'}</td>
            <td class="px-4 py-4 text-sm text-gray-300">${course.views || 0}</td>
            <td class="px-4 py-4">
              <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-600/20 text-green-300 border border-green-600/30">
                Active
              </span>
            </td>
            <td class="px-4 py-4 text-sm">
              <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="editCourse('${course.id}')">Edit</button>
              <button class="text-yellow-400 hover:text-yellow-300 mr-2" onclick="viewCourse('${course.id}')">View</button>
              <button class="text-red-400 hover:text-red-300" onclick="deleteCourse('${course.id}')">Delete</button>
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      function populateVideosTable(videos) {
        const tbody = document.getElementById('videos-table-body');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (!videos || videos.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                No videos found.
              </td>
            </tr>
          `;
          return;
        }

        videos.forEach(video => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-800/30 transition-colors duration-200';

          const sizeMB = video.size ? (video.size / (1024 * 1024)).toFixed(1) : '0.0';

          row.innerHTML = `
            <td class="px-4 py-4">
              <div class="font-medium text-white">${video.title}</div>
              <div class="text-sm text-gray-400">${video.description || ''}</div>
            </td>
            <td class="px-4 py-4 text-sm text-gray-300">${video.course || 'N/A'}</td>
            <td class="px-4 py-4 text-sm text-gray-300">${video.duration || '0:00'}</td>
            <td class="px-4 py-4 text-sm text-gray-300">${sizeMB} MB</td>
            <td class="px-4 py-4">
              <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-600/20 text-green-300 border border-green-600/30">
                Ready
              </span>
            </td>
            <td class="px-4 py-4 text-sm">
              <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="editVideo('${video.id}')">Edit</button>
              <button class="text-yellow-400 hover:text-yellow-300 mr-2" onclick="previewVideo('${video.id}')">Preview</button>
              <button class="text-red-400 hover:text-red-300" onclick="deleteVideo('${video.id}')">Delete</button>
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      function populateCategoriesTable(categories) {
        const tbody = document.getElementById('categories-table-body');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (!categories || categories.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="px-4 py-8 text-center text-gray-400">
                No categories found.
              </td>
            </tr>
          `;
          return;
        }

        categories.forEach(category => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-800/30 transition-colors duration-200';

          row.innerHTML = `
            <td class="px-4 py-4">
              <div class="font-medium text-white">${category.name}</div>
              <div class="text-sm text-gray-400">${category.description || ''}</div>
            </td>
            <td class="px-4 py-4 text-sm text-gray-300">${category.courseCount || 0}</td>
            <td class="px-4 py-4 text-sm text-gray-300">${category.videoCount || 0}</td>
            <td class="px-4 py-4 text-sm text-gray-300 max-w-xs truncate">${category.description || 'No description'}</td>
            <td class="px-4 py-4 text-sm">
              <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="editCategory('${category.id}')">Edit</button>
              <button class="text-red-400 hover:text-red-300" onclick="deleteCategory('${category.id}')">Delete</button>
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      // API Management Functions
      function populateAPIEndpoints() {
        const tbody = document.getElementById('api-endpoints-body');
        if (!tbody) return;

        const endpoints = [
          { path: '/api/categories', method: 'GET', status: 'Healthy', responseTime: '23ms', requestsPerMin: 45, errorRate: '0.01%' },
          { path: '/api/courses', method: 'GET', status: 'Healthy', responseTime: '34ms', requestsPerMin: 67, errorRate: '0.02%' },
          { path: '/api/videos', method: 'GET', status: 'Healthy', responseTime: '28ms', requestsPerMin: 89, errorRate: '0.00%' },
          { path: '/api/auth', method: 'POST', status: 'Healthy', responseTime: '45ms', requestsPerMin: 23, errorRate: '0.05%' },
          { path: '/api/users', method: 'GET', status: 'Healthy', responseTime: '31ms', requestsPerMin: 12, errorRate: '0.00%' },
          { path: '/api/codes', method: 'POST', status: 'Healthy', responseTime: '38ms', requestsPerMin: 8, errorRate: '0.00%' }
        ];

        tbody.innerHTML = '';

        endpoints.forEach(endpoint => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-800/30 transition-colors duration-200';

          const statusColor = endpoint.status === 'Healthy' ? 'text-green-400' : 'text-red-400';

          row.innerHTML = `
            <td class="px-4 py-4">
              <code class="text-sm text-green-300 bg-gray-800/50 px-2 py-1 rounded">${endpoint.path}</code>
            </td>
            <td class="px-4 py-4">
              <span class="px-2 py-1 text-xs font-medium rounded bg-gray-700/50 text-gray-300">${endpoint.method}</span>
            </td>
            <td class="px-4 py-4">
              <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-600/20 ${statusColor} border border-green-600/30">
                ${endpoint.status}
              </span>
            </td>
            <td class="px-4 py-4 text-sm text-gray-300">${endpoint.responseTime}</td>
            <td class="px-4 py-4 text-sm text-gray-300">${endpoint.requestsPerMin}</td>
            <td class="px-4 py-4 text-sm text-gray-300">${endpoint.errorRate}</td>
            <td class="px-4 py-4 text-sm">
              <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="testAPI('${endpoint.path}')">Test</button>
              <button class="text-yellow-400 hover:text-yellow-300 mr-2" onclick="viewAPIDetails('${endpoint.path}')">Details</button>
              <button class="text-purple-400 hover:text-purple-300" onclick="viewAPIDocs('${endpoint.path}')">Docs</button>
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      // Content Management Event Handlers
      function setupContentManagementTabs() {
        const tabs = ['courses', 'videos', 'categories', 'media'];
        const contents = tabs.map(tab => `${tab}-content`);

        tabs.forEach((tab, index) => {
          const tabElement = document.getElementById(`${tab}-tab`);
          const contentElement = document.getElementById(`${tab}-content`);

          if (tabElement && contentElement) {
            tabElement.addEventListener('click', () => {
              // Hide all content sections
              contents.forEach(contentId => {
                const content = document.getElementById(contentId);
                if (content) content.classList.add('hidden');
              });

              // Remove active state from all tabs
              tabs.forEach(tabId => {
                const tabEl = document.getElementById(`${tabId}-tab`);
                if (tabEl) {
                  tabEl.classList.remove('bg-green-600/20', 'text-green-300');
                  tabEl.classList.add('text-gray-400', 'hover:text-gray-300');
                }
              });

              // Show selected content and activate tab
              contentElement.classList.remove('hidden');
              tabElement.classList.add('bg-green-600/20', 'text-green-300');
              tabElement.classList.remove('text-gray-400', 'hover:text-gray-300');
            });
          }
        });
      }

      // Placeholder functions for content management
      function editCourse(id) { showNotification(`Edit course ${id}`, 'info'); }
      function viewCourse(id) { showNotification(`View course ${id}`, 'info'); }
      function deleteCourse(id) {
        if (confirm(`Delete course ${id}?`)) {
          showNotification(`Course ${id} deleted`, 'success');
        }
      }

      function editVideo(id) { showNotification(`Edit video ${id}`, 'info'); }
      function previewVideo(id) { showNotification(`Preview video ${id}`, 'info'); }
      function deleteVideo(id) {
        if (confirm(`Delete video ${id}?`)) {
          showNotification(`Video ${id} deleted`, 'success');
        }
      }

      function editCategory(id) { showNotification(`Edit category ${id}`, 'info'); }
      function deleteCategory(id) {
        if (confirm(`Delete category ${id}?`)) {
          showNotification(`Category ${id} deleted`, 'success');
        }
      }

      function testAPI(path) { showNotification(`Testing API ${path}`, 'info'); }
      function viewAPIDetails(path) { showNotification(`API details for ${path}`, 'info'); }
      function viewAPIDocs(path) { showNotification(`API documentation for ${path}`, 'info'); }
    </script>
  </body>
</html>
